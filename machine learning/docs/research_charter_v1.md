# 机器学习量化研究宪章 v1.0

**制定日期**: 2025年10月24日  
**适用范围**: 股票量化预测/排序模型  
**宪章版本**: v1.0  
**审核状态**: 待审批

---

## 📋 执行摘要（30秒速览）

### 核心目标
- **股票池**: 初期单股票验证（000001），后期扩展至沪深300/中证500
- **预测目标**: `future_return_5d`（未来5日对数收益率）
- **模型类型**: Ridge/RandomForest/LightGBM回归 + 分桶排序策略

### 核心验收标准（必须全部满足）
| 指标类别 | 关键指标 | 最低标准 | 
|---------|---------|---------|
| 预测能力 | Rank IC | \|IC\| ≥ 0.02 且 p < 0.05 |
| 分层效果 | Top-Bottom Spread | Spread > 0（测试集） |
| 策略表现 | 成本后夏普比率 | Sharpe > 1.0 |
| 风险控制 | 最大回撤 | MaxDD < 20% |
| 稳定性 | 训练-测试差异 | \|IC_test - IC_train\| / \|IC_train\| < 30% |

### 立即终止红线（任一触发即回滚）
1. **测试集Spread ≤ 0** → 分层失效
2. **成本后Sharpe ≤ 0** → 策略无效
3. **最大回撤 > 30%** → 风险失控
4. **破坏性对照失败** → 当期收益IC显著高于未来收益IC（数据泄漏）

### 当前状态（截至2025-10-24）
- **项目阶段**: 开发阶段（baseline_v1）
- **最新回测**: 2025-10-15，策略夏普=-1.803，❌ 未通过验收
- **主要问题**: 聚类验证未通过、随机基准排名低（10%分位）
- **下一步**: 特征优化、扩展数据集、调整聚类参数

---

## 1. 研究目标与边界

### 1.1 目标市场/股票池

**主要标的**:
- **初始阶段**: 单股票验证（000001平安银行）
- **扩展阶段**: 沪深300/中证500成分股（带历史成分变更）
- **时间范围**: 2022-01-01 至今，最少3年历史数据

**交易约束**:
- ✅ 剔除ST/退市股票（`exclude_st: true`）
- ✅ 剔除停牌、涨跌停标的（数据预处理阶段）
- ✅ 上市天数 ≥ 60日（新股过滤）
- ✅ 最低日成交量 ≥ 1,000,000（`min_volume`）
- ✅ 最低价格 ≥ 1.0元（`min_price`）
- ✅ 最低换手率约束（防止流动性风险）

**股票池执行细则**（扩展阶段）:

1. **成分股获取来源**:
   - 数据源: AkShare（`ak.index_stock_cons()`）或本地CSV文件
   - 更新频率: 月度（每月初更新成分变更）
   - 存储位置: `data/universe/hs300_history.csv`, `zz500_history.csv`
   - 字段要求: `date`, `ticker`, `name`, `in_index`（是否在指数中）

2. **历史成分变更处理**:
   - 回测时使用**时点成分**（point-in-time），避免前视偏差
   - 示例: 2023-06-01的沪深300成分应使用2023-05-31收盘后公布的名单
   - 代码位置: `data/data_loader.py:load_universe()`（需实现）

3. **过滤规则执行顺序**:
   ```
   原始股票池
   ↓ 过滤1: ST/退市（基于股票名称或AkShare的ST标记）
   ↓ 过滤2: 停牌（当日成交量=0或数据缺失）
   ↓ 过滤3: 涨跌停（涨跌幅 > ±9.5%，ST股为±4.5%）
   ↓ 过滤4: 上市龄（`(today - list_date).days >= 60`）
   ↓ 过滤5: 成交量（`volume >= min_volume`）
   ↓ 过滤6: 价格（`close >= min_price`）
   ↓ 过滤7: 换手率（`turnover_rate >= min_turnover`，如0.5%）
   ↓ 最终股票池
   ```
   - 代码位置: `data/data_loader.py:apply_filters()`（需实现）
   - 过滤日志: 保存到 `ML output/datasets/baseline_v1/filter_log.csv`

4. **单股票vs多股票模式切换**:
   - 通过配置文件 `data.universe.type` 控制: `"single"` 或 `"multi"`
   - 单股票: 直接使用 `data.symbol`，全局分桶
   - 多股票: 使用 `data.universe.index_name`（如"hs300"），按日横截面分桶

### 1.2 预测目标

**主要目标**: 
- `future_return_5d`: 未来5日对数收益率（主要）
- `future_return_1d`: 未来1日收益率（辅助）
- `future_return_10d`: 未来10日收益率（备选）

**目标处理**:
- 收益率类型: 对数收益率（`return_type: log`）
- 极值裁剪: 1%-99%分位数（`clip_quantile: [0.01, 0.99]`）
- 防泄漏验证: 尾部NaN保留检查

---

## 2. 核心评估指标（横截面口径）

### 2.1 样本内指标（训练+验证集）

#### 信息系数（IC）
- **Pearson IC**: 相关系数，衡量线性预测能力（`stats.pearsonr`）
- **Spearman Rank IC**: 排序相关系数（主要指标，`stats.spearmanr`）
  - **目标值**: |Rank IC| ≥ 0.02（待实际测试确定）
  - **优秀值**: |Rank IC| ≥ 0.05（待实际测试确定）
  - **统计显著性**: p-value < 0.05
  - **代码位置**: `evaluation/metrics.py:calculate_metrics()`

#### ICIR（信息系数比率）
- **定义**: ICIR = mean(daily_IC) / std(daily_IC)
- **目标值**: ICIR ≥ 0.5（待实际测试确定）
- **优秀值**: ICIR ≥ 1.0（待实际测试确定）
- **年化归一**: 按交易日数归一（√252）
- **代码位置**: `evaluation/metrics.py:calculate_ic_by_date()`（需实现ICIR计算）
- **⚠️ 单股票场景**: ICIR需要时间序列变化，单股票时使用滚动窗口IC（如20日）计算，而非每日横截面IC

#### IC胜率
- **定义**: 日度IC > 0的比例（多股票横截面）或滚动IC > 0的比例（单股票）
- **目标值**: IC胜率 ≥ 55%（待实际测试确定）
- **优秀值**: IC胜率 ≥ 60%（待实际测试确定）
- **代码位置**: 需基于`calculate_ic_by_date()`结果计算
- **⚠️ 单股票场景**: 使用滚动20日窗口计算IC序列，统计正值比例

### 2.2 分桶收益分析

#### 分桶设置
- **分桶数量**: 5分位（Quintile，`n_buckets: 5`）
- **分桶方法**: 
  - 多股票: 按日横截面等频分桶（`bucket_method: quantile`, `cross_section: true`）
  - 单股票: 全局等频分桶（`cross_section: false`）
- **代码位置**: `evaluation/bucketing.py:bucket_predictions()`

#### 核心指标
- **Top桶收益**: 最高分位平均收益（`mean_y_true`）
  - **目标**: Top桶收益 > 全体均值（验收标准）
  - **代码**: `bucketing.py:analyze_bucket_performance()`
  
- **Bottom桶收益**: 最低分位平均收益
  - **目标**: Bottom桶收益 < 全体均值（建议）

- **Top-Bottom Spread**: 多空收益差
  - **定义**: `spread = top_bucket['mean_y_true'] - bottom_bucket['mean_y_true']`
  - **目标**: Spread > 0（验收标准）
  - **代码**: `bucketing.py:analyze_bucket_performance()`
  
- **Top-Mean Spread**: Top桶超越全体表现
  - **目标**: Top-Mean > 0（验收标准）

- **分层单调性**: 桶1-5收益递增
  - **目标**: 单调性良好（无严重反转）

#### 累计净值曲线
- **Top桶净值**: 跟踪最高分位数累计收益
- **全体等权净值**: 作为基准对比
- **Bottom桶净值**: 跟踪最低分位数表现

### 2.3 样本外指标（测试集）

#### 泛化能力检验
- **测试集 Rank IC**: 
  - **合格**: |IC_test| ≥ 0.02 且方向一致
  - **优秀**: |IC_test| ≥ 0.8 × |IC_train|
  
- **测试集 Spread**:
  - **合格**: Spread_test > 0
  - **优秀**: Spread_test ≥ 0.7 × Spread_train

#### 稳定性约束
- **训练-测试差异**: 
  - **合格**: |IC_test - IC_train| / |IC_train| < 30%
  - **优秀**: < 20%
  
- **分层方向一致性**: 
  - Top桶在测试集排名 ≤ 50%
  - Bottom桶在测试集排名 ≥ 50%

---

## 3. 策略组合指标（成本后）

### 3.1 收益指标

- **总收益率**: 测试期累计收益
- **年化收益率**: 年化后的收益（按252交易日）
  - **目标**: 年化收益 > 无风险利率（3%）
  - **优秀**: 年化收益 > 15%

### 3.2 风险调整指标

- **夏普比率**: `Sharpe = (annual_return - risk_free_rate) / volatility`
  - **目标**: Sharpe > 1.0（待实际测试确定）
  - **优秀**: Sharpe > 1.5（待实际测试确定）
  - **无风险利率**: 默认0.03（3%）
  - **代码位置**: `backtest/top_bucket_backtest.py:calculate_strategy_performance()`

- **最大回撤**: 从峰值到谷底的最大损失
  - **计算**: `max_drawdown = np.min(drawdown)`，其中`drawdown = (equity - cummax) / cummax`
  - **目标**: 最大回撤 < 20%（待实际测试确定）
  - **优秀**: 最大回撤 < 10%（待实际测试确定）
  - **代码位置**: `backtest/top_bucket_backtest.py:calculate_strategy_performance()`

- **胜率**: 持有期间日收益 > 0的比例（T+1对齐）
  - **计算**: `win_rate = (returns[signal_mask] > 0).mean()`
  - **目标**: 胜率 > 50%（待实际测试确定）
  - **优秀**: 胜率 > 55%（待实际测试确定）
  - **代码位置**: `backtest/top_bucket_backtest.py:calculate_strategy_performance()`

- **盈亏比**: 平均盈利 / 平均亏损
  - **目标**: 盈亏比 > 1.0（待实际测试确定）
  - **优秀**: 盈亏比 > 1.5（待实际测试确定）
  - **代码位置**: 需在回测模块中实现

### 3.3 交易成本与容量

#### 成本假设
- **佣金费率**: 0.03%（双边，配置项`backtest.transaction_cost.commission: 0.0003`）
- **滑点**: 0.10%（双边，配置项`backtest.transaction_cost.slippage: 0.0010`）
- **总成本**: 约0.26%每回合（(0.03% + 0.10%) × 2 = 0.26%）
- **配置位置**: `configs/ml_baseline.yml` → `backtest.transaction_cost`
- **计费方式**: 按交易回合数（roundtrips）计费
  - `roundtrips = signal_changes / 2.0`
  - `total_cost = roundtrips * (commission + slippage) * 2`
- **代码要求**: 回测模块必须从配置文件读取，禁止硬编码

#### 容量约束
- **换手率**: 
  - **计算**: 基于信号翻转次数和持有期
  - **目标**: 合理控制（待实际测试确定具体阈值）

- **成本侵蚀比例**: 
  - **计算**: `cost_erosion = total_cost / abs(gross_return)`
  - **目标**: 成本侵蚀 < 50%（待实际测试确定）
  - **优秀**: 成本侵蚀 < 30%（待实际测试确定）

- **持仓集中度**: 
  - 单股最大权重 < 20%（未来多股票池时适用）
  - 单行业最大权重 < 40%（未来多股票池时适用）

---

## 4. 数据切分与防泄漏标准

### 4.1 时间切分

- **训练集**: 60%（`train_ratio: 0.6`）
- **验证集**: 20%（`valid_ratio: 0.2`）
- **测试集**: 20%（`test_ratio: 0.2`）

### 4.2 防泄漏机制（8层防护）

| 层级 | 机制 | 验收标准 |
|------|------|----------|
| 1️⃣ | 特征shift(1) | 所有特征滞后1期 |
| 2️⃣ | 标签尾部NaN保留 | 尾部保留5/10个NaN |
| 3️⃣ | PCA时间切分 | 严格时间顺序切分 |
| 4️⃣ | Purge gap | 删除切分点前10天（≥max_target_period） |
| 5️⃣ | Scaler fit-transform分离 | 仅训练集fit |
| 6️⃣ | PCA fit-transform分离 | 仅训练集fit |
| 7️⃣ | 模型fit-predict分离 | 仅训练集fit |
| 8️⃣ | 策略T+1执行对齐 | 今日信号→明日仓位 |

### 4.3 破坏性对照实验

- **错误标签1**: 过去5日收益（动量检测）
  - **合格**: |IC_past| < 3.0 × |IC_future|
  
- **错误标签2**: 随机标签（噪声检测）
  - **合格**: |IC_random| < |IC_future|
  
- **错误标签3**: 当期收益（对齐检测）
  - **合格**: |IC_current| < |IC_future|

---

## 5. 终止与回滚标准

### 5.1 立即终止条件（红线）

任何一条触发即终止当前实验，回滚至上一稳定版本：

1. **测试集Spread为负**
   - `Spread_test ≤ 0`（分桶分析）
   
2. **ICIR显著回落**（待实现）
   - `ICIR_test < 0.3 × ICIR_train`
   
3. **成本后夏普<0**
   - `Sharpe_after_cost ≤ 0`（策略回测）
   
4. **最大回撤超阈**
   - `Max_Drawdown > 30%`（具体阈值待确定）
   
5. **破坏性对照失败**（待实现）
   - 当期收益IC显著高于未来收益IC（对齐错误）
   - `|IC_current| > 2.0 × |IC_future|`

### 5.2 警告条件（黄线）

触发后需人工审查，决定是否继续：

1. **泛化能力弱**（待实现日度IC追踪）
   - `|IC_test| < 0.5 × |IC_train|`
   
2. **分层单调性差**（聚类分析中已实现）
   - Top桶在测试集排名 > 60%（见`clustering_validation_results.csv`）
   
3. **成本侵蚀高**（待在回测中实现）
   - 成本侵蚀比例 > 60%
   
4. **IC胜率低**（待实现日度IC统计）
   - IC胜率 < 50%

### 5.3 版本回滚流程

1. **记录问题**: 在 `/docs/experiment_log.md` 记录失败原因
2. **保留数据**: 将失败实验移至 `/ML output/failed/`
3. **恢复版本**: 回滚至最近一次验收通过的版本
4. **根因分析**: 分析触发原因（特征/模型/参数）
5. **改进计划**: 制定下一轮实验方案

---

## 6. 实验线分级管理

### 6.1 主线（Production Line）

**准入标准**（待实际测试后确定具体数值）:
- ✅ 所有验收指标通过
- ✅ 测试集表现稳定（差异 < 20%，具体阈值待定）
- ✅ 成本后夏普 > 某阈值（待定）
- ✅ 至少2个股票验证成功

**当前配置** (from `configs/ml_baseline.yml`):
- **项目**: baseline_v1
- **模型**: Ridge/RandomForest/LightGBM回归
- **特征**: 20个精选技术特征（`features.use_scaled_features: true`）
- **目标**: future_return_5d（5日对数收益率）
- **状态**: 开发阶段（尚未建立稳定主线）

### 6.2 实验线（Experimental Line）

**适用场景**:
- 新特征测试（如深度学习自动特征）
- 新模型测试（如LSTM、Transformer）
- 新策略测试（如状态门控、PCA聚类）

**降级条件**:
- 无法带来统计显著增益（增益 < 5%）
- 复杂度显著提升（训练时间 > 2倍）
- 泛化能力未通过验证

**实验记录**:
- 实验编号: EXP-YYYYMMDD-序号
- 记录位置: `/docs/experiments/`
- 包含内容: 假设、方法、结果、结论

### 6.3 归档线（Archive Line）

**归档条件**:
- 已证明无效的方法
- 已被更优方法替代
- 不符合当前研究方向

**归档位置**: `/ML output/archived/`

---

## 7. 验收检查清单

### 7.1 数据质量检查

- [ ] 数据无缺失或合理填充
- [ ] 无异常值（经过winsorize处理）
- [ ] 时间索引连续无跳跃
- [ ] 标签尾部NaN正确保留

### 7.2 特征工程检查

- [ ] 所有特征已shift(1)
- [ ] 特征标准化仅在训练集fit
- [ ] 特征数量在合理范围（10-30个）
- [ ] 无高相关特征对（r < 0.95）

### 7.3 模型训练检查

- [ ] 模型仅在训练集拟合
- [ ] 验证集用于超参数调优
- [ ] 测试集完全未参与训练
- [ ] Purge gap正确设置（≥10天）

### 7.4 回测验证检查

- [ ] 信号T+1执行对齐
- [ ] 交易成本已计入
- [ ] 随机基准对比通过
- [ ] 权益曲线保存完整

### 7.5 性能指标检查

- [ ] Rank IC ≥ 0.02 且 p < 0.05
- [ ] Top-Bottom Spread > 0
- [ ] 夏普比率 > 1.0（成本后）
- [ ] 最大回撤 < 20%
- [ ] 训练-测试差异 < 20%

### 7.6 诊断报告检查

- [ ] 破坏性对照实验通过
- [ ] 动量分析合理（延续/反转）
- [ ] 成本侵蚀比例 < 50%
- [ ] 状态过滤方向一致
- [ ] IC胜率 > 55%

---

## 8. 报告输出要求

### 8.1 必须输出文件

**训练阶段**:
- `reports/model_metrics.json`: 模型指标汇总（需包含ICIR、IC胜率）
- `reports/bucket_performance.csv`: 分桶表现详情
- `reports/test_predictions.csv`: 测试集预测明细
- `reports/summary.json`: 实验总结（需包含验收结果True/False）
- `datasets/filter_log.csv`: 股票池过滤日志（多股票时）

**回测阶段**:
- `reports/strategy_equity.csv`: 权益曲线数据
- `reports/strategy_analysis.txt`: 策略分析报告
- `reports/triage_report.txt`: 快速诊断报告

**模型保存**:
- `models/{model_name}_model.pkl`: 训练好的模型
- `scalers/scaler_meta.json`: 标准化元数据
- `states/states_pca_{split}.npy`: PCA状态（如使用）

**实验记录**（用于阈值确定和审计）:
- `docs/experiments/metrics_history.csv`: 累积所有实验的关键指标
  - 字段: `exp_id`, `date`, `symbol`, `rank_ic_train`, `rank_ic_test`, `spread_train`, `spread_test`, `sharpe`, `max_dd`, `validation_passed`
- `docs/experiments/EXP-YYYYMMDD-NNN.md`: 单次实验的详细记录

### 8.2 可视化要求

**必需图表**:
- 分桶累计收益曲线（5分位对比）
- 策略权益曲线（vs基准）
- IC时序图（带胜率统计）
- 回撤曲线

**可选图表**:
- 特征重要性排序
- PCA方差解释比例
- 聚类散点图（如使用）
- 年度收益对比柱状图

---

## 9. 宪章执行与更新

### 9.1 执行责任

- **研究员**: 严格按宪章执行实验
- **审查员**: 每月审查实验记录
- **宪章维护人**: 根据实践反馈更新宪章

### 9.2 宪章更新条件

- 累计实验 > 10次后
- 发现新的泄漏风险
- 市场环境重大变化
- 监管政策调整

### 9.3 验收阈值的确定机制

**原则**: 所有性能阈值必须基于实验数据设定，避免"拍脑袋"。

**初始阶段**（实验次数 < 10）:
- 使用保守的行业经验值作为临时标准
- 当前文档中标注"待实际测试确定"的指标均属此类
- 每次实验后记录关键指标到 `/docs/experiments/metrics_history.csv`

**稳定阶段**（实验次数 ≥ 10）:
- **IC类指标**: 以最近10次有效实验的P30分位数作为"目标值"，P50作为"优秀值"
- **Sharpe/回撤**: 以最近10次的P40分位数作为"目标值"
- **Spread**: 必须 > 0（硬约束），以中位数的0.7倍作为"优秀值"
- **成本侵蚀**: 以P60分位数作为"警告线"

**更新频率**: 每季度审查一次，或累计新增10次实验后

**示例**（假设10次实验的Rank IC分布为 [0.018, 0.023, 0.031, ..., 0.052]）:
- P30 ≈ 0.025 → 设为"目标值"
- P50 ≈ 0.035 → 设为"优秀值"
- 写入宪章并标注生效日期

### 9.4 版本历史

| 版本 | 日期 | 主要变更 | 批准人 |
|------|------|----------|--------|
| v1.0 | 2025-10-24 | 初版制定 | HaOooMi |

---

## 10. 附录：实际运行参考

**重要说明**: 
- 本宪章中的所有阈值和目标值都需要通过实际测试来确定
- 以下数据来自项目历史运行记录，仅供参考，不代表最终验收标准

### 10.1 聚类分析历史记录（2025-10-15）

**数据集**: 000001（平安银行）

**聚类验证结果** (from `clustering_validation_results.csv`):
- k=4: train_difference=0.0313, 训练显著性=True, 测试排名=3/4, 测试稳定性=False, 总体验证=False
- k=5: train_difference=0.0450, 训练显著性=True, 测试排名=4/5, 测试稳定性=False, 总体验证=False  
- k=6: train_difference=0.0440, 训练显著性=True, 测试排名=N/A, 测试稳定性=False, 总体验证=False

**观察**: 所有k值均未通过测试集稳定性验证（test_top_50_percent=False）

### 10.2 策略回测历史记录（2025-10-15）

**测试期间**: 2023-01-01 ~ 2023-12-01

**选中聚类**:
- 聚类1: k=5, cluster_id=4, 训练收益=+0.1393%, 测试收益=+0.1890%
- 聚类2: k=6, cluster_id=0, 训练收益=+0.0909%, 测试收益=+0.1209%

**性能指标** (from `strategy_analysis_000001_20251015_205433.txt`):
- 基准总收益: -48.33%
- 策略净收益: -15.57%（含成本）
- 超额收益: +32.77%
- 策略夏普比率: -1.803
- 策略最大回撤: -13.83%
- 信号胜率: 25.00%（T+1对齐）
- 回合数: 3.0
- 随机基准排名: 10.0%分位

**验收结果**: ❌ 未通过（优于随机基准比例过低）

### 10.3 结论

**当前状态**: 
- 模型处于早期开发阶段
- 聚类验证和策略回测均未达到理想水平
- 需要进一步优化特征工程、模型选择和参数调优

**下一步建议**:
1. 扩展数据集（更多股票、更长时间）
2. 优化特征选择和聚类参数
3. 测试不同的策略构建方法
4. 完善评估指标和验收标准
5. 通过多次实验确定合理的阈值

---

**宪章签署**:

研究负责人: _________________  日期: _________________

审核人: _________________  日期: _________________

---

*本宪章为"研究宪法"，旨在锁定研究方向、防止跑偏、确保样本外有效性。*  
*所有偏离宪章的实验必须记录并说明原因。*
