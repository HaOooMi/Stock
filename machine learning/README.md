# æœºå™¨å­¦ä¹ é‡åŒ–é€‰è‚¡æ¡†æ¶

åŸºäº Learning-to-Rank çš„ A è‚¡å¤šå› å­é€‰è‚¡ç³»ç»Ÿï¼Œå®ç°ä»æ•°æ®åŠ è½½ã€å› å­å·¥ç¨‹ã€æ¨¡å‹è®­ç»ƒåˆ°ç»„åˆå›æµ‹çš„å®Œæ•´é‡åŒ–ç ”ç©¶æµç¨‹ã€‚

---

## ğŸ“Œ é¡¹ç›®ç‰¹è‰²

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| **å®Œæ•´ç ”ç©¶æµç¨‹** | æ•°æ®å¿«ç…§ â†’ å› å­å·¥ç¨‹ â†’ æ¨¡å‹è®­ç»ƒ â†’ æ¨ªæˆªé¢è¯„ä¼° â†’ ç»„åˆå›æµ‹ |
| **å·¥ä¸šçº§æ•°æ®ç®¡ç†** | ç‰ˆæœ¬åŒ–å¿«ç…§ã€PIT å¯¹é½ã€7 å±‚å¯äº¤æ˜“æ€§è¿‡æ»¤ |
| **ä¸‰æ¡çº¿å¯¹æ¯”** | Regression / Reg-on-Rank / LambdaRank å¯¹æ¯”å®éªŒ |
| **æ¼‚ç§»ç›‘æ§** | PSI ç‰¹å¾æ¼‚ç§» + IC/Spread é¢„æµ‹æ¼‚ç§»åŒé‡æ£€æµ‹ |
| **æ— åå›æµ‹** | Open-to-Open æ‰§è¡Œæ¨¡å¼ï¼Œç¬¦åˆ A è‚¡ T+1 åˆ¶åº¦ |

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ•°æ®åŠ è½½å±‚                                â”‚
â”‚  InfluxDB â†’ MarketDataLoader â†’ TradabilityFilter â†’ PITAligner  â”‚
â”‚                    â†’ DataSnapshot (ç‰ˆæœ¬åŒ–å­˜å‚¨)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å› å­å·¥ç¨‹å±‚                                â”‚
â”‚  FeatureEngineer + FactorFactory (5 å¤§ç±»å› å­)                  â”‚
â”‚       â†’ Winsorize â†’ Standardize â†’ Neutralize (å¸‚å€¼+è¡Œä¸š)       â”‚
â”‚       â†’ IC/ICIR è´¨é‡æ£€æŸ¥ â†’ FactorLibraryManager (å…¥åº“)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ¨¡å‹è®­ç»ƒå±‚                                â”‚
â”‚  TimeSeriesCV (Purge+Embargo) â†’ DriftDetector (PSI)            â”‚
â”‚       â†’ Ridge / RF / LightGBM / LGBMRanker                     â”‚
â”‚       â†’ DriftDetector (IC/Spread é¢„æµ‹æ¼‚ç§»)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        è¯„ä¼°å›æµ‹å±‚                                â”‚
â”‚  Bucketing â†’ CrossSectionAnalyzer â†’ SimplePortfolioBacktester  â”‚
â”‚       â†’ Tearsheet (HTML æŠ¥å‘Š + å¯è§†åŒ–å›¾è¡¨)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‚ ç›®å½•ç»“æ„è¯¦è§£

### data/ - æ•°æ®å¤„ç†å±‚

| æ¨¡å— | ç±»/åŠŸèƒ½ |
|------|---------|
| `data_loader.py` | `DataLoader` - ç»Ÿä¸€æ•°æ®æ¥å£ï¼Œé›†æˆå¿«ç…§ç®¡ç†ã€äº¤æ˜“è¿‡æ»¤ã€PIT å¯¹é½ |
| `data_snapshot.py` | `DataSnapshot` - ç‰ˆæœ¬åŒ–æ•°æ®å¿«ç…§ï¼ˆæ ¼å¼ï¼š`ds_2025Q4_v1`ï¼‰ï¼Œå«å®Œæ•´æ€§æ ¡éªŒ |
| `market_data_loader.py` | `MarketDataLoader` - InfluxDB è¡Œæƒ…åŠ è½½ |
| `financial_data_loader.py` | `FinancialDataLoader` - å­£åº¦è´¢åŠ¡æŠ¥è¡¨åŠ è½½ |
| `time_series_cv.py` | `TimeSeriesCV` - Purge + Embargo æ—¶åºåˆ‡åˆ† |
| `tradability_filter.py` | `TradabilityFilter` - 7 å±‚è¿‡æ»¤ï¼šST/åœç‰Œ/æ¶¨è·Œåœ/ä¸Šå¸‚é¾„/æˆäº¤é‡/ä»·æ ¼/æ¢æ‰‹ç‡ |
| `pit_aligner.py` | `PITDataAligner` - è´¢åŠ¡æ•°æ® PIT å¯¹é½ï¼šå…¬å‘Šæ—¥ + æ»åç”Ÿæ•ˆ + å‰å¤æƒ |

### features/ - å› å­å·¥ç¨‹å±‚

| æ¨¡å— | ç±»/åŠŸèƒ½ |
|------|---------|
| `feature_engineering.py` | `FeatureEngineer` - åŸºç¡€ç‰¹å¾å·¥ç¨‹ï¼šæŠ€æœ¯æŒ‡æ ‡ç”Ÿæˆ + ç‰¹å¾é€‰æ‹© + æ ‡å‡†åŒ– |
| `factor_factory.py` | `FactorFactory` - é«˜çº§å› å­å·¥å‚ï¼š5 å¤§å› å­æ—ï¼Œå«æ–‡çŒ®å¼•ç”¨ |
| `factor_library_manager.py` | `FactorLibraryManager` - å› å­åº“ç‰ˆæœ¬æ§åˆ¶ + å…¥åº“æ ‡å‡† + å› å­æ¸…å•ç»´æŠ¤ |

**å› å­å·¥å‚æ–¹æ³•ï¼ˆFactorFactoryï¼‰**ï¼š

| æ–¹æ³• | å› å­æ— | è¯´æ˜ |
|------|--------|------|
| `calc_roc_family()` | åŠ¨é‡ | ROC_5/10/20/60/120 |
| `calc_price_to_sma()` | åŠ¨é‡ | ä»·æ ¼åç¦»å‡çº¿ |
| `calc_long_short_momentum()` | åŠ¨é‡ | é•¿åŠ¨é‡-çŸ­åè½¬å¤åˆ |
| `calc_rank_momentum()` | åŠ¨é‡ | æ’ååŠ¨é‡ |
| `calc_realized_volatility()` | æ³¢åŠ¨ç‡ | å·²å®ç°æ³¢åŠ¨ç‡ |
| `calc_parkinson_volatility()` | æ³¢åŠ¨ç‡ | Parkinson æ³¢åŠ¨ç‡ |
| `calc_garman_klass_volatility()` | æ³¢åŠ¨ç‡ | Garman-Klass æ³¢åŠ¨ç‡ |
| `calc_return_skewness_kurtosis()` | æ³¢åŠ¨ç‡ | æ”¶ç›Šååº¦/å³°åº¦ |
| `calc_turnover_factors()` | é‡ä»· | æ¢æ‰‹ç‡å› å­ |
| `calc_volume_price_correlation()` | é‡ä»· | é‡ä»·ç›¸å…³æ€§ |
| `calc_vwap_deviation()` | é‡ä»· | VWAP åç¦»åº¦ |
| `calc_amihud_illiquidity()` | é‡ä»· | Amihud éæµåŠ¨æ€§ |
| `calc_price_range_factors()` | é‡ä»· | ä»·æ ¼åŒºé—´å› å­ |
| `calc_v1_core_factors()` | æ ¸å¿ƒ | A è‚¡ç‰¹åŒ–å› å­ï¼ˆåè½¬/ä½æ³¢/ååšå½©ï¼‰ |

### targets/ - æ ‡ç­¾å¤„ç†å±‚

| æ¨¡å— | ç±»/åŠŸèƒ½ |
|------|---------|
| `target_engineering.py` | `TargetEngineer` - ç”Ÿæˆæœªæ¥æ”¶ç›Šç‡ã€åˆ†ç±»æ ‡ç­¾ã€é˜²æ³„æ¼å¤„ç† |
| `ranking_labels.py` | `RankingLabelFactory` - LambdaRank åˆ†æ¡¶æ ‡ç­¾ç”Ÿæˆï¼ˆGaussRank/åˆ†ç®±ï¼‰ |
| `label_transformer.py` | `LabelTransformer` - æ”¶ç›Šç‡å˜æ¢ï¼šGaussRankã€æ®‹å·®åŒ–ã€æ’ååŒ– |

### models/ - æ¨¡å‹å±‚

| æ¨¡å— | ç±»/åŠŸèƒ½ |
|------|---------|
| `base_model.py` | `BaseModel` - æŠ½è±¡åŸºç±»ï¼Œç»Ÿä¸€æ¥å£ï¼šfit / predict / save / load |
| `lgbm_model.py` | `LightGBMModel` - LightGBM å›å½’ï¼šæ¢¯åº¦æå‡æ ‘ + æ—©åœ + ç‰¹å¾é‡è¦æ€§ |
| `lgbm_ranker.py` | `LightGBMRanker` - LightGBM LambdaRankï¼šç›´æ¥ä¼˜åŒ– NDCG æ’åºæŒ‡æ ‡ |
| `ridge_model.py` | `RidgeModel` - Ridge å›å½’ï¼šL2 æ­£åˆ™åŒ–çº¿æ€§æ¨¡å‹ |
| `rf_model.py` | `RandomForestModel` - éšæœºæ£®æ—ï¼šBagging é›†æˆæ ‘ |
| `transformers/pca.py` | `PCAStateGenerator` - PCA é™ç»´çŠ¶æ€ç”Ÿæˆå™¨ |

### evaluation/ - è¯„ä¼°å±‚

| æ¨¡å— | ç±»/åŠŸèƒ½ |
|------|---------|
| `cross_section_analyzer.py` | `CrossSectionAnalyzer` - æ¨ªæˆªé¢åˆ†æå™¨ï¼šå°è£… IC/ICIR/Spread/å•è°ƒæ€§è®¡ç®— |
| `cross_section_adapter.py` | `CrossSectionAdapter` - æ¨ªæˆªé¢æ•°æ®é€‚é…å™¨ |
| `cross_section_metrics.py` | æ ¸å¿ƒåº¦é‡å‡½æ•°ï¼š`calculate_forward_returns()`ã€Rank ICã€åˆ†æ¡¶æ”¶ç›Š |
| `factor_preprocessing.py` | å› å­é¢„å¤„ç†å‡½æ•°ï¼š`winsorize_factor()`ã€`standardize_factor()`ã€ä¸­æ€§åŒ– |
| `drift_detector.py` | `DriftDetector` - æ¼‚ç§»æ£€æµ‹ï¼šPSI åˆ†å¸ƒæ¼‚ç§» + IC/Spread é¢„æµ‹æ¼‚ç§» |
| `bucketing.py` | åˆ†æ¡¶å‡½æ•°ï¼š`bucket_predictions()` - æŒ‰æ—¥æ¨ªæˆªé¢åˆ†æ¡¶ |
| `metrics.py` | åŸºç¡€æŒ‡æ ‡å‡½æ•°ï¼š`calculate_metrics()`ã€`calculate_ic_by_date()` |
| `tearsheet.py` | HTML Tearsheet æŠ¥å‘Šç”Ÿæˆï¼š`generate_html_tearsheet()` |
| `visualization.py` | å¯è§†åŒ–å‡½æ•°ï¼šIC æ—¶åºã€åˆ†æ¡¶æ”¶ç›Šã€Spread ç´¯è®¡ã€æ¢æ‰‹ç‡ã€æœˆåº¦çƒ­åŠ›å›¾ |
| `reporting.py` | æŠ¥å‘Šç”Ÿæˆï¼š`generate_report()` |
| `cluster/cluster_evaluate.py` | `ClusterEvaluator` - K-means èšç±»è¯„ä¼° + èšç±»æ”¶ç›Šåˆ†æ |

### backtest/ - å›æµ‹å±‚

| æ¨¡å— | ç±»/åŠŸèƒ½ |
|------|---------|
| `simple_backtest.py` | `SimplePortfolioBacktester` - Top-K ç­–ç•¥å›æµ‹ï¼ˆv2.0ï¼‰ï¼šç­‰æƒ/åˆ†æ•°åŠ æƒ + è°ƒä»“é¢‘ç‡ + åŸºå‡†å¯¹æ¯” + äº¤æ˜“æˆæœ¬ |
| `top_bucket_backtest.py` | `StrategyBacktest` - åˆ†æ¡¶ç­–ç•¥å›æµ‹ï¼šé€‰æ‹©é¢„æµ‹æœ€é«˜æ¡¶æ„å»ºç»„åˆ |
| `cluster_strategy_backtest.py` | `StrategyBacktest` - èšç±»ä¿¡å·ç­–ç•¥ï¼šåŸºäºèšç±»æ ‡ç­¾æ„å»ºç»„åˆ |

### pipelines/ - æ‰§è¡Œç®¡é“

| æ¨¡å— | åŠŸèƒ½ |
|------|------|
| `run_baseline_pipeline.py` | ä¸»è®­ç»ƒç®¡é“ï¼šä¸‰æ¡çº¿å¯¹æ¯”ï¼ˆå›å½’/Reg-on-Rank/LambdaRankï¼‰+ æ¨ªæˆªé¢è¯„ä¼° + å›æµ‹ |
| `prepare_factors.py` | å› å­å‡†å¤‡ï¼šç”Ÿæˆ â†’ è´¨é‡æ£€æŸ¥ â†’ IC è¯„ä¼° â†’ å…¥åº“ |
| `prepare_data.py` | æ•°æ®å‡†å¤‡ï¼ˆæ— å¿«ç…§ï¼‰ |
| `prepare_data_with_snapshot.py` | æ•°æ®å‡†å¤‡ + å¿«ç…§åˆ›å»º |
| `run_cluster_analysis.py` | èšç±»åˆ†æè¿è¡Œè„šæœ¬ |
| `run_pca_state.py` | PCA é™ç»´åˆ†æè¿è¡Œè„šæœ¬ |

### æ ¹ç›®å½•

| æ¨¡å— | åŠŸèƒ½ |
|------|------|
| `main.py` | `MLPipeline` - ç»Ÿä¸€å…¥å£ï¼šä¸²è” prepare_data â†’ prepare_factors â†’ train |

---

## ğŸ”§ æ ¸å¿ƒæœºåˆ¶è¯¦è§£

### 1. æ•°æ®å¿«ç…§ç³»ç»Ÿ

**ç‰ˆæœ¬å‘½åè§„åˆ™**ï¼š`ds_YYYYQQ_vN`ï¼ˆå¦‚ `ds_2025Q4_v1`ï¼‰

**æ•°æ®è´¨é‡æ£€æŸ¥é¡¹**ï¼š

| æ£€æŸ¥é¡¹ | çº¢ç¯é˜ˆå€¼ | è¯´æ˜ |
|--------|----------|------|
| ç¼ºå¤±ç‡ | > 20% | ç‰¹å¾ç¼ºå¤±è¿‡å¤š |
| é‡å¤æ•°æ® | > 1% | æ•°æ®é‡å¤è®°å½• |
| å¯äº¤æ˜“æ ·æœ¬ | < 70% | æœ‰æ•ˆæ ·æœ¬å¤ªå°‘ |
| æå€¼æ¯”ä¾‹ | > 5% | å¼‚å¸¸å€¼è¿‡å¤š |

**å¿«ç…§åŒ…å«**ï¼š
- ç‰¹å¾çŸ©é˜µï¼ˆParquetï¼‰
- æ ‡ç­¾æ•°æ®ï¼ˆParquetï¼‰
- å…ƒæ•°æ® JSONï¼ˆé…ç½®ã€ç»Ÿè®¡ã€å“ˆå¸Œæ ¡éªŒï¼‰

### 2. æ—¶åºäº¤å‰éªŒè¯ï¼ˆPurge + Embargoï¼‰

```
æ—¶é—´è½´ï¼š
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     Train      â”‚      Valid      â”‚       Test       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â†‘ purge_end                       â†‘ embargo_start
   (train_end - purge_days)      (valid_end + embargo_days)
```

**å‚æ•°è®¾ç½®å»ºè®®**ï¼š

| å‚æ•° | å»ºè®®å€¼ | è¯´æ˜ |
|------|--------|------|
| purge_days | â‰¥ max_horizon | é¿å…ç›®æ ‡æ ‡ç­¾é‡å  |
| embargo_days | horizon / 2 | é¿å…ä¿¡æ¯æ¸—é€ |
| train_ratio | 60% | è®­ç»ƒé›†å æ¯” |
| valid_ratio | 20% | éªŒè¯é›†å æ¯” |

### 3. å› å­ä¸­æ€§åŒ–ï¼ˆå›å½’æ®‹å·®æ³•ï¼‰

å¯¹æ¯ä¸ªæˆªé¢æ—¥æœŸæ‰§è¡Œï¼š

```
factor_neutralized = factor - Î²â‚ Ã— log(market_cap) - Î²â‚‚ Ã— industry_dummies
```

**å¤„ç†æµæ°´çº¿é¡ºåº**ï¼š
1. **Winsorize**ï¼š1%-99% åˆ†ä½æ•°æˆªæ–­
2. **Standardize**ï¼šZ-score = (x - Î¼) / Ïƒ
3. **Neutralize**ï¼šå¸‚å€¼ + è¡Œä¸šå›å½’æ®‹å·®

### 4. PSI æ¼‚ç§»æ£€æµ‹

**Population Stability Index**ï¼š

```
PSI = Î£ (actual_pct - expected_pct) Ã— ln(actual_pct / expected_pct)
```

| PSI å€¼ | åˆ¤æ–­ |
|--------|------|
| < 0.1 | åˆ†å¸ƒç¨³å®š âœ“ |
| 0.1 ~ 0.2 | è½»å¾®æ¼‚ç§» âš ï¸ |
| â‰¥ 0.2 | æ˜¾è‘—æ¼‚ç§» âŒ |

### 5. æ¨ªæˆªé¢è¯„ä¼°æŒ‡æ ‡

| æŒ‡æ ‡ | å…¬å¼ | è¯´æ˜ |
|------|------|------|
| Rank IC | Spearman(é¢„æµ‹åˆ†æ•°, å®é™…æ”¶ç›Š) | æ¯æ—¥æ¨ªæˆªé¢ç›¸å…³ |
| ICIR | mean(IC) / std(IC) | IC ç¨³å®šæ€§ |
| ICIR å¹´åŒ– | ICIR Ã— âˆš252 | å¹´åŒ–ä¿¡æ¯æ¯”ç‡ |
| Top-Mean Spread | mean(Topæ¡¶æ”¶ç›Š) - mean(å…¨ä½“æ”¶ç›Š) | å¤´éƒ¨è¶…é¢æ”¶ç›Š |
| å•è°ƒæ€§ | åˆ†æ¡¶æ”¶ç›Šæ˜¯å¦å•è°ƒé€’å¢ | å› å­æœ‰æ•ˆæ€§éªŒè¯ |

### 6. å›æµ‹æ‰§è¡Œæ¨¡å¼ï¼ˆv2.0ï¼‰

**Open-to-Openï¼ˆå›ºå®šæ¨¡å¼ï¼‰**ï¼š

```
T æ—¥æ”¶ç›˜ â†’ è®¡ç®—ä¿¡å· â†’ T+1 æ—¥å¼€ç›˜ä¹°å…¥ â†’ T+H æ—¥å¼€ç›˜å–å‡º
```

- âœ… ç¬¦åˆ A è‚¡ T+1 åˆ¶åº¦
- âœ… ä¿¡å·ä¸æ‰§è¡Œæœ‰å……è¶³æ—¶é—´å·®
- âœ… é¿å…æ”¶ç›˜ç«ä»·åšå¼ˆ

**å›æµ‹å™¨åŠŸèƒ½**ï¼ˆ`SimplePortfolioBacktester`ï¼‰ï¼š
- **é€‰è‚¡è§„åˆ™**ï¼šTop-K é¢„æµ‹åˆ†æ•°æœ€é«˜çš„è‚¡ç¥¨
- **æƒé‡æ–¹å¼**ï¼šç­‰æƒï¼ˆ1/Kï¼‰æˆ–åˆ†æ•°åŠ æƒï¼ˆsoftmaxï¼‰
- **è°ƒä»“é¢‘ç‡**ï¼šæ—¥åº¦ï¼ˆ1Dï¼‰/ å‘¨åº¦ï¼ˆ1Wï¼‰/ æœˆåº¦ï¼ˆ1Mï¼‰
- **äº¤æ˜“æˆæœ¬**ï¼šä½£é‡‘ + å°èŠ±ç¨ + æ»‘ç‚¹
- **åŸºå‡†å¯¹æ¯”**ï¼šæ”¯æŒç­‰æƒåŸºå‡†æˆ–æŒ‡æ•°åŸºå‡†ï¼Œè®¡ç®— Alpha/Beta/IR
- **è¾“å‡ºå›¾è¡¨**ï¼šå‡€å€¼æ›²çº¿ã€å›æ’¤ã€æœˆåº¦çƒ­åŠ›å›¾ã€æ¢æ‰‹ç‡

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒé…ç½®

```bash
# Conda å®‰è£…ï¼ˆæ¨èï¼‰
conda env create -f environment.yml
conda activate ML

# pip å®‰è£…
pip install -r requirements.txt
```

**Python ç‰ˆæœ¬**ï¼š3.9+ï¼ˆå·²æµ‹è¯• 3.9.23ï¼‰

**ç‰¹æ®Šä¾èµ–**ï¼šTA-Lib éœ€é¢„è£… C åº“

### 2. æ•°æ®æºé…ç½®

ç¼–è¾‘ `configs/ml_baseline.yml`ï¼š

```yaml
data:
  influxdb:
    enabled: true
    url: "http://localhost:8086"
    org: "stock"
    bucket: "stock_kdata"
    token: "YOUR_TOKEN"
```

### 3. è¿è¡Œå®Œæ•´æµç¨‹

```bash
# ç»Ÿä¸€å…¥å£
python main.py

# å¿«é€Ÿæ¨¡å¼ï¼ˆè·³è¿‡æ¼‚ç§»æ£€æµ‹ï¼‰
python main.py --skip_drift

# ä¸‰æ¡çº¿å¯¹æ¯”
python main.py --compare_all

# ä»…è¿è¡Œç‰¹å®šæ­¥éª¤
python main.py --only prepare_data
python main.py --only prepare_factors
python main.py --only train
```

### 4. ç›´æ¥è¿è¡Œå­ç®¡é“

```bash
# æ•°æ®å‡†å¤‡ + å¿«ç…§
python pipelines/prepare_data_with_snapshot.py

# å› å­å·¥ç¨‹ + IC è¯„ä¼°
python pipelines/prepare_factors.py

# è®­ç»ƒ + è¯„ä¼° + å›æµ‹
python pipelines/run_baseline_pipeline.py --compare_all --skip_drift

# èšç±»åˆ†æ
python pipelines/run_cluster_analysis.py

# PCA é™ç»´
python pipelines/run_pca_state.py
```

---

## ğŸ“Š è¾“å‡ºäº§ç‰©

### ç›®å½•ç»“æ„

```
ML output/
â”œâ”€â”€ datasets/           # æ•°æ®å¿«ç…§
â”‚   â””â”€â”€ ds_2025Q4_v1/
â”‚       â”œâ”€â”€ features.parquet
â”‚       â”œâ”€â”€ labels.parquet
â”‚       â””â”€â”€ metadata.json
â”œâ”€â”€ models/             # æ¨¡å‹æ–‡ä»¶
â”‚   â””â”€â”€ baseline_v1/
â”‚       â”œâ”€â”€ regression_model.pkl
â”‚       â”œâ”€â”€ regression_rank_model.pkl
â”‚       â””â”€â”€ lambdarank_model.pkl
â”œâ”€â”€ predictions/        # é¢„æµ‹ç»“æœ
â”‚   â””â”€â”€ baseline_v1/
â”‚       â””â”€â”€ test_predictions.parquet
â”œâ”€â”€ reports/            # è¯„ä¼°æŠ¥å‘Š
â”‚   â””â”€â”€ baseline_v1/
â”‚       â”œâ”€â”€ model_comparison.json
â”‚       â”œâ”€â”€ drift_report.json
â”‚       â”œâ”€â”€ factor_ic_report.json
â”‚       â”œâ”€â”€ regression_backtest/
â”‚       â”‚   â”œâ”€â”€ portfolio_weights.parquet
â”‚       â”‚   â”œâ”€â”€ daily_returns.parquet
â”‚       â”‚   â””â”€â”€ backtest_stats.json
â”‚       â””â”€â”€ ...
â””â”€â”€ figures/            # å¯è§†åŒ–å›¾è¡¨
    â””â”€â”€ baseline_v1/
        â”œâ”€â”€ regression_backtest.png
        â”œâ”€â”€ ic_timeseries.png
        â”œâ”€â”€ bucket_returns.png
        â””â”€â”€ drawdown.png
```

### è¯„ä¼°æŠ¥å‘Šç¤ºä¾‹

**ä¸‰æ¡çº¿å¯¹æ¯”**ï¼š

```
ä»»åŠ¡ç±»å‹                Mean IC     ICIR      ICIR(å¹´åŒ–)   Spread
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
regression            0.0674      0.3878     6.16        0.0046
regression_rank       0.0543      0.3772     5.99        0.0017
lambdarank            0.0316      0.2101     3.34        0.0035
```

**å›æµ‹ç»©æ•ˆ**ï¼š

```
ç­–ç•¥              å¹´åŒ–æ”¶ç›Š   æ³¢åŠ¨ç‡    å¤æ™®æ¯”ç‡   æœ€å¤§å›æ’¤   Alpha    Beta
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Top-20 ç­‰æƒ       12.5%     18.3%     0.68      -22.1%    8.2%    0.85
åŸºå‡†ï¼ˆç­‰æƒï¼‰       5.0%     20.5%     0.24      -35.2%    -       1.00
```

---

## âš™ï¸ é…ç½®æ–‡ä»¶è¯´æ˜

`configs/ml_baseline.yml` ä¸»è¦é…ç½®æ®µï¼š

| é…ç½®æ®µ | è¯´æ˜ |
|--------|------|
| `project` | é¡¹ç›®åç§°ã€ç‰ˆæœ¬ã€æè¿° |
| `paths` | å„ç±»è¾“å‡ºç›®å½•é…ç½® |
| `data` | è‚¡ç¥¨æ± ã€æ—¥æœŸèŒƒå›´ã€InfluxDB è¿æ¥ã€äº¤æ˜“è¿‡æ»¤å‚æ•°ã€PIT å¯¹é½ |
| `features` | é¢„å¤„ç†å‚æ•°ã€å› å­å·¥å‚é…ç½®ã€ä¸­æ€§åŒ–è®¾ç½® |
| `target` | ç›®æ ‡å˜é‡åã€é¢„æµ‹å‘¨æœŸã€æ”¶ç›Šç±»å‹ |
| `split` | è®­ç»ƒ/éªŒè¯/æµ‹è¯•æ¯”ä¾‹ã€Purge/Embargo å¤©æ•° |
| `ranking` | ä»»åŠ¡ç±»å‹ã€åˆ†æ¡¶æ•°ã€NDCG è¯„ä¼°ä½ç½® |
| `models` | å„æ¨¡å‹å‚æ•°ï¼ˆRidge/RF/LightGBM/LGBMRankerï¼‰ |
| `evaluation` | åˆ†æ¡¶æ•°ã€è¯„ä¼°æŒ‡æ ‡åˆ—è¡¨ |
| `backtest` | è°ƒä»“é¢‘ç‡ã€Top-Kã€äº¤æ˜“æˆæœ¬ã€åŸºå‡†é…ç½® |

---

## ğŸ“ˆ å› å­è´¨é‡æ ‡å‡†

### å…¥åº“æ ‡å‡†ï¼ˆä¸¤æ¡£ï¼‰

| æ ‡å‡† | IC å‡å€¼ | ICIR | p-value | é€‚ç”¨åœºæ™¯ |
|------|---------|------|---------|----------|
| ä¸¥æ ¼ | â‰¥ 0.02 | â‰¥ 0.5 | < 0.05 | ç”Ÿäº§çº§å› å­ |
| æ¢ç´¢ | â‰¥ 0.005 | â‰¥ 0.15 | < 0.10 | ç ”ç©¶çº§å› å­ |

### æ¼‚ç§»ç›‘æ§æ ‡å‡†

| æŒ‡æ ‡ | é˜ˆå€¼ | è¯´æ˜ |
|------|------|------|
| ç‰¹å¾ PSI | < 0.2 | åˆ†å¸ƒç¨³å®š |
| Valid vs Test IC å·® | < 30% | é¢„æµ‹ä¸€è‡´ |
| åˆæ ¼å› å­æ•° | â‰¥ 10 | æœ€å°æ•°é‡ |

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: "æ— æ³•åŠ è½½ä»·æ ¼æ•°æ®"

**åŸå› **ï¼šInfluxDB è¿æ¥å¤±è´¥

**è§£å†³**ï¼š
1. æ£€æŸ¥ InfluxDB æœåŠ¡ï¼š`http://localhost:8086`
2. éªŒè¯ token å’Œ bucket é…ç½®
3. ç¡®è®¤æ•°æ®å·²å¯¼å…¥

### Q2: IC ä¸å›æµ‹æ”¶ç›Šä¸æˆæ­£æ¯”

**åŸå› **ï¼šIC è¡¡é‡é¢„æµ‹èƒ½åŠ›ï¼Œå›æµ‹å—äº¤æ˜“æˆæœ¬ã€æµåŠ¨æ€§ã€æç«¯è¡Œæƒ…å½±å“

**å»ºè®®**ï¼š
- æ§åˆ¶æ¢æ‰‹ç‡ï¼ˆé™ä½è°ƒä»“é¢‘ç‡è‡³ 1W æˆ– 1Mï¼‰
- å¢åŠ é€‰è‚¡æ•°é‡ï¼ˆåˆ†æ•£é£é™©ï¼‰
- è¡Œä¸šä¸­æ€§åŒ–ï¼ˆé¿å…é£æ ¼æš´éœ²ï¼‰

### Q3: Alpha ä¸ºè´Ÿ

**å¯èƒ½åŸå› **ï¼š
1. IC è¿‡ä½ï¼ˆ< 0.02ï¼‰
2. è°ƒä»“è¿‡é¢‘ï¼ˆæˆæœ¬åå™¬æ”¶ç›Šï¼‰
3. å› å­å¤±æ•ˆæœŸï¼ˆå¸‚åœºé£æ ¼åˆ‡æ¢ï¼‰

### Q4: LambdaRank æ•ˆæœä¸å¦‚å›å½’

**åŸå› **ï¼šLambdaRank åªå…³å¿ƒæ’åºï¼Œå¯¹æç«¯å€¼ä¸æ•æ„Ÿ

**é€‚ç”¨åœºæ™¯**ï¼š
- é€‰è‚¡æ•°é‡è¾ƒå°‘ï¼ˆTop-10/20ï¼‰
- åªå…³å¿ƒå¤´éƒ¨æ’åºè´¨é‡
- åŸå§‹æ”¶ç›Šåˆ†å¸ƒæç«¯

### Q5: å›æµ‹å‡€å€¼æ›²çº¿ä¸ºä»€ä¹ˆä¸å¹³æ»‘ï¼Ÿ

**åŸå› **ï¼šè°ƒä»“é¢‘ç‡è¶Šä½ï¼ˆå¦‚æœˆåº¦ï¼‰ï¼Œå‡€å€¼æ›²çº¿è¶Šå‘ˆé˜¶æ¢¯çŠ¶

**è§£å†³**ï¼šè¿™æ˜¯æ­£å¸¸ç°è±¡ï¼Œåæ˜ äº†çœŸå®çš„è°ƒä»“èŠ‚å¥ã€‚å¦‚éœ€æ›´å¹³æ»‘å¯å°† `rebalance_freq` æ”¹ä¸º `'1W'` æˆ– `'1D'`ï¼Œä½†ä¼šå¢åŠ äº¤æ˜“æˆæœ¬ã€‚

---

**å¼€å§‹ä½ çš„é‡åŒ–ç ”ç©¶ä¹‹æ—…ï¼** ğŸš€
