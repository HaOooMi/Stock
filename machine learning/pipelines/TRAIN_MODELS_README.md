# æœºå™¨å­¦ä¹ åŸºçº¿è®­ç»ƒç³»ç»Ÿ

## é˜¶æ®µ 12ï¼šæœºå™¨å­¦ä¹ åŸºçº¿ï¼ˆå›å½’/æ’åºï¼‰

### åŠŸèƒ½æ¦‚è¿°

æœ¬ç³»ç»Ÿå®ç°äº†å®Œæ•´çš„æœºå™¨å­¦ä¹ åŸºçº¿è®­ç»ƒæµç¨‹ï¼š

1. **æ•°æ®åŠ è½½**: ä»ML outputåŠ è½½æ ‡å‡†åŒ–ç‰¹å¾å’Œç›®æ ‡æ•°æ®
2. **æ•°æ®åˆ‡åˆ†**: æ—¶é—´åºåˆ—åˆ‡åˆ†ï¼ˆé˜²æ³„æ¼ï¼Œæ”¯æŒpurgeï¼‰
3. **æ¨¡å‹è®­ç»ƒ**: Ridgeã€RandomForestã€LightGBMï¼ˆå¯é€‰ï¼‰
4. **é¢„æµ‹è¯„ä¼°**: æµ‹è¯•é›†é¢„æµ‹ï¼Œè®¡ç®—MSEã€MAEã€ICã€Rank IC
5. **åˆ†æ¡¶åˆ†æ**: æŒ‰æ—¥æ¨ªæˆªé¢åˆ†5æ¡¶ï¼Œç»Ÿè®¡æ¯æ¡¶çœŸå®æ”¶ç›Š
6. **ç­–ç•¥å›æµ‹**: Topæ¡¶ç­–ç•¥æ”¶ç›Šå¯¹æ¯”
7. **æŠ¥å‘Šç”Ÿæˆ**: CSVæŠ¥å‘Šã€JSONæ‘˜è¦ã€TXTè¯¦ç»†æŠ¥å‘Š

### éªŒæ”¶æ ‡å‡†

- âœ… Topæ¡¶æ”¶ç›Š > å…¨ä½“å‡å€¼
- âœ… Spreadï¼ˆTop - Bottomï¼‰> 0

### ç›®å½•ç»“æ„

```
machine learning/
â”œâ”€â”€ train_models.py          # ä¸»è®­ç»ƒè„šæœ¬
â”œâ”€â”€ configs/
â”‚   â””â”€â”€ ml_baseline.yml      # é…ç½®æ–‡ä»¶
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ data_loader.py       # æ•°æ®åŠ è½½å™¨
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ base_model.py        # åŸºç¡€æ¨¡å‹ç±»
â”‚   â”œâ”€â”€ ridge_model.py       # Ridgeå›å½’
â”‚   â”œâ”€â”€ rf_model.py          # éšæœºæ£®æ—
â”‚   â””â”€â”€ lgbm_model.py        # LightGBM
â”œâ”€â”€ evaluation/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ metrics.py           # è¯„ä¼°æŒ‡æ ‡
â”‚   â”œâ”€â”€ bucketing.py         # åˆ†æ¡¶åˆ†æ
â”‚   â””â”€â”€ reporting.py         # æŠ¥å‘Šç”Ÿæˆ
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ splitting.py         # æ—¶é—´åºåˆ—åˆ‡åˆ†
â”‚   â””â”€â”€ logger.py            # æ—¥å¿—è®¾ç½®
â””â”€â”€ ML output/
    â”œâ”€â”€ scaler_*_scaled_features.csv  # æ ‡å‡†åŒ–ç‰¹å¾
    â”œâ”€â”€ with_targets_*_complete_*.csv # ç›®æ ‡æ•°æ®
    â””â”€â”€ reports/                      # è¾“å‡ºæŠ¥å‘Š
```

### ä½¿ç”¨æ­¥éª¤

#### 1. å®‰è£…ä¾èµ–

```bash
pip install pandas numpy scikit-learn scipy pyyaml
pip install lightgbm  # å¯é€‰ï¼Œå¦‚æœå®‰è£…å¤±è´¥ä¼šè‡ªåŠ¨è·³è¿‡
```

#### 2. å‡†å¤‡æ•°æ®

ç¡®ä¿å·²è¿è¡Œå‰ç½®æ­¥éª¤ï¼š
- `feature_engineering.py` - ç”Ÿæˆç‰¹å¾
- `target_engineering.py` - ç”Ÿæˆç›®æ ‡
- ç¡®ä¿å­˜åœ¨æ ‡å‡†åŒ–ç‰¹å¾æ–‡ä»¶

#### 3. é…ç½®å‚æ•°

ç¼–è¾‘ `configs/ml_baseline.yml`ï¼š

```yaml
data:
  symbol: "000001"            # è‚¡ç¥¨ä»£ç 
  start_date: "2022-01-01"
  end_date: "2024-12-31"

target:
  name: "future_return_5d"    # ç›®æ ‡å˜é‡

split:
  train_ratio: 0.6            # è®­ç»ƒé›†60%
  valid_ratio: 0.2            # éªŒè¯é›†20%
  test_ratio: 0.2             # æµ‹è¯•é›†20%
  purge_days: 10              # é˜²æ³„æ¼æ¸…é™¤å¤©æ•°

models:
  ridge:
    enabled: true
    params:
      alpha: [0.1, 1.0, 10.0, 100.0]  # CVé€‰æ‹©æœ€ä¼˜alpha
  
  random_forest:
    enabled: true
    params:
      n_estimators: 500
      max_depth: 10
  
  lightgbm:
    enabled: true              # å¦‚æœæœªå®‰è£…ä¼šè‡ªåŠ¨è·³è¿‡
    params:
      n_estimators: 500
      learning_rate: 0.05

evaluation:
  n_buckets: 5                 # åˆ†5æ¡¶
  bucket_method: "quantile"    # ç­‰åˆ†ä½åˆ†æ¡¶
```

#### 4. è¿è¡Œè®­ç»ƒ

```bash
cd "d:\vscode projects\stock\machine learning"
python train_models.py --config configs/ml_baseline.yml
```

æˆ–ä½¿ç”¨é»˜è®¤é…ç½®ï¼š

```bash
python train_models.py
```

#### 5. æŸ¥çœ‹ç»“æœ

è®­ç»ƒå®Œæˆåï¼Œæ£€æŸ¥è¾“å‡ºç›®å½• `ML output/reports/`ï¼š

- **model_bucket_performance.csv**: å„æ¨¡å‹å„æ¡¶çš„è¡¨ç°ç»Ÿè®¡
- **test_predictions.csv**: æµ‹è¯•é›†é¢„æµ‹æ˜ç»†
- **summary.json**: è¯„ä¼°æ‘˜è¦ï¼ˆåŒ…å«éªŒæ”¶ç»“æœï¼‰
- **evaluation_report.txt**: è¯¦ç»†çš„å¯è¯»æŠ¥å‘Š

### è¾“å‡ºç¤ºä¾‹

#### æ§åˆ¶å°è¾“å‡º

```
======================================================================
ğŸš€ æœºå™¨å­¦ä¹ åŸºçº¿è®­ç»ƒ
======================================================================

ğŸ“‹ åŠ è½½é…ç½®...
   âœ… é…ç½®åŠ è½½å®Œæˆ
   ğŸ² éšæœºç§å­: 42

ğŸ“Š åŠ è½½æ•°æ®...
   âœ… æ•°æ®åŠ è½½å®Œæˆ
      ç‰¹å¾æ•°: 20
      æ ·æœ¬æ•°: 580

ğŸ“… æ•°æ®åˆ‡åˆ†...
   âœ… åˆ‡åˆ†å®Œæˆ:
      è®­ç»ƒé›†: 340 æ ·æœ¬, 2022-01-04 ~ 2023-09-26
      éªŒè¯é›†: 120 æ ·æœ¬, 2023-10-17 ~ 2024-05-28
      æµ‹è¯•é›†: 120 æ ·æœ¬, 2024-06-11 ~ 2024-12-30

ğŸ¤– æ¨¡å‹è®­ç»ƒ...

ğŸ“Œ è®­ç»ƒRidgeæ¨¡å‹
   ğŸ”§ è®­ç»ƒ Ridge æ¨¡å‹...
      ğŸ” ä½¿ç”¨äº¤å‰éªŒè¯é€‰æ‹©æœ€ä¼˜alpha: [0.1, 1.0, 10.0, 100.0]
      âœ… æœ€ä¼˜alpha: 1.0000
      â±ï¸  è®­ç»ƒæ—¶é—´: 0.05ç§’
      ğŸ“Š è®­ç»ƒé›† MSE: 0.000123, MAE: 0.008456
      ğŸ“Š éªŒè¯é›† MSE: 0.000145, MAE: 0.009123

ğŸŒ² è®­ç»ƒRandomForestæ¨¡å‹
   ...

ğŸ¯ æµ‹è¯•é›†é¢„æµ‹ä¸è¯„ä¼°...
   ğŸ“Š è¯„ä¼° Ridge æ¨¡å‹
      MSE: 0.000134
      MAE: 0.008789
      IC: 0.2345 (p=0.0089)
      Rank IC: 0.2567 (p=0.0045)

ğŸ“Š åˆ†æ¡¶åˆ†æ...
   ğŸª£ Ridge åˆ†æ¡¶åˆ†æ
   ğŸ“Š æŒ‰æ—¥æ¨ªæˆªé¢åˆ†5æ¡¶ (æ–¹æ³•: quantile)
   âœ… åˆ†æ¡¶å®Œæˆ: 120/120 æ ·æœ¬

   ğŸ“Š Topæ¡¶ (æ¡¶5): å¹³å‡æ”¶ç›Š 0.0156
   ğŸ“Š Bottomæ¡¶ (æ¡¶1): å¹³å‡æ”¶ç›Š -0.0089
   ğŸ“ˆ Top-Bottom Spread: 0.0245

âœ… éªŒæ”¶æ£€æŸ¥...
   Ridge:
      Topæ¡¶ > å…¨ä½“å‡å€¼: âœ… (0.015600 vs 0.003200)
      Spread > 0: âœ… (0.024500)
      éªŒæ”¶ç»“æœ: âœ… é€šè¿‡

ğŸ‰ è®­ç»ƒæµç¨‹å®Œæˆï¼
======================================================================

ğŸ“Š æ¨¡å‹æ•°é‡: 3
ğŸ“ˆ æµ‹è¯•æ ·æœ¬: 120

ğŸ† æœ€ä½³æ¨¡å‹: LightGBM
   Rank IC: 0.2891
   Topæ¡¶æ”¶ç›Š: 0.0178
   Spread: 0.0287
   éªŒæ”¶: âœ… é€šè¿‡

ğŸ“ æŠ¥å‘Šç›®å½•: machine learning/ML output/reports
```

#### CSVæŠ¥å‘Šç¤ºä¾‹ (model_bucket_performance.csv)

| model | bucket | n_obs | mean_y_true | std_y_true | mean_y_pred | Top-Bottom |
|-------|--------|-------|-------------|------------|-------------|------------|
| Ridge | 1 | 24 | -0.0089 | 0.0123 | -0.0156 | - |
| Ridge | 2 | 24 | -0.0012 | 0.0098 | -0.0045 | - |
| Ridge | 3 | 24 | 0.0034 | 0.0089 | 0.0023 | - |
| Ridge | 4 | 24 | 0.0098 | 0.0112 | 0.0089 | - |
| Ridge | 5 | 24 | 0.0156 | 0.0145 | 0.0198 | 0.0245 |

### é«˜çº§é…ç½®

#### 1. è°ƒæ•´äº¤æ˜“æˆæœ¬

```yaml
backtest:
  transaction_cost:
    commission: 0.0003    # åŒè¾¹ä½£é‡‘0.03%
    slippage: 0.0010      # åŒè¾¹æ»‘ç‚¹0.1%
```

#### 2. ä¿®æ”¹åˆ†æ¡¶æ–¹æ³•

```yaml
evaluation:
  n_buckets: 10           # æ”¹ä¸º10æ¡¶
  bucket_method: "equal_width"  # ç­‰å®½åˆ†æ¡¶
```

#### 3. å¯ç”¨ç¼“å­˜

```yaml
runtime:
  use_cache: true
  cache_dir: "machine learning/ML output/cache"
```

### æ•…éšœæ’é™¤

#### é—®é¢˜1: LightGBMå®‰è£…å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
```bash
# Windows
pip install --upgrade pip setuptools wheel
pip install lightgbm

# æˆ–è€…ç›´æ¥ç¦ç”¨LightGBM
# åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®: lightgbm.enabled = false
```

#### é—®é¢˜2: æ‰¾ä¸åˆ°ç‰¹å¾æ–‡ä»¶

**è§£å†³æ–¹æ¡ˆ**:
1. ç¡®ä¿å·²è¿è¡Œ `feature_engineering.py`
2. æ£€æŸ¥ `ML output/` ç›®å½•ä¸‹æ˜¯å¦å­˜åœ¨ `scaler_*_scaled_features.csv`
3. ç¡®è®¤é…ç½®æ–‡ä»¶ä¸­çš„ `symbol` ä¸æ–‡ä»¶ååŒ¹é…

#### é—®é¢˜3: YAMLæ¨¡å—æœªå®‰è£…

**è§£å†³æ–¹æ¡ˆ**:
```bash
pip install pyyaml
```

#### é—®é¢˜4: éªŒæ”¶æœªé€šè¿‡

**åŸå› åˆ†æ**:
- ç‰¹å¾è´¨é‡ä¸è¶³
- ç›®æ ‡å˜é‡å™ªå£°è¿‡å¤§
- æ¨¡å‹å‚æ•°ä¸åˆé€‚
- æ ·æœ¬é‡ä¸è¶³

**è§£å†³æ–¹æ¡ˆ**:
1. å¢åŠ æ›´å¤šæœ‰æ•ˆç‰¹å¾
2. è°ƒæ•´ç›®æ ‡çª—å£ï¼ˆå¦‚æ”¹ä¸º10æ—¥ï¼‰
3. ä¼˜åŒ–æ¨¡å‹è¶…å‚æ•°
4. æ‰©å¤§æ•°æ®æ—¶é—´èŒƒå›´

### ä¸‹ä¸€æ­¥å·¥ä½œ

1. **ç‰¹å¾ä¼˜åŒ–**: æ·»åŠ æ›´å¤šæŠ€æœ¯æŒ‡æ ‡ã€åŸºæœ¬é¢ç‰¹å¾
2. **æ¨¡å‹é›†æˆ**: Stackingã€åŠ æƒå¹³å‡
3. **è¶…å‚ä¼˜åŒ–**: ä½¿ç”¨Optunaç­‰å·¥å…·
4. **å¤šæ ‡çš„**: æ‰©å±•åˆ°å¤šåªè‚¡ç¥¨
5. **æ»šåŠ¨è®­ç»ƒ**: å®ç°walk-forwardéªŒè¯
6. **é£é™©æ§åˆ¶**: æ·»åŠ æ­¢æŸã€ä»“ä½ç®¡ç†

### å‚è€ƒæ–‡çŒ®

- [scikit-learnæ–‡æ¡£](https://scikit-learn.org/)
- [LightGBMæ–‡æ¡£](https://lightgbm.readthedocs.io/)
- ã€ŠPythoné‡åŒ–äº¤æ˜“ã€‹- é»„å®‡

### ä½œè€…ä¸æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. é…ç½®æ–‡ä»¶æ˜¯å¦æ­£ç¡®
2. æ•°æ®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
3. Pythonç¯å¢ƒæ˜¯å¦å®Œæ•´

---

**ç‰ˆæœ¬**: 1.0.0  
**æ›´æ–°æ—¥æœŸ**: 2025-10-20
