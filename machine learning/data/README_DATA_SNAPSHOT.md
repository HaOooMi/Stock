# æ•°æ®æ¸…æ´—ä¸å¿«ç…§å±‚ - ä½¿ç”¨æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æ•°æ®æ¸…æ´—ä¸å¿«ç…§å±‚æ˜¯ç¬¦åˆç ”ç©¶å®ªç« è¦æ±‚çš„æ ¸å¿ƒæ•°æ®å¤„ç†æ¨¡å—ï¼Œç¡®ä¿æ•°æ®çš„æ— åæ€§å’Œå¯è¿½æº¯æ€§ã€‚

### æ ¸å¿ƒåŠŸèƒ½

1. **æ•°æ®å¿«ç…§ç®¡ç†** - æ•°æ®ç‰ˆæœ¬åŒ–å’Œå¯è¿½æº¯æ€§
2. **äº¤æ˜“å¯è¡Œæ€§è¿‡æ»¤** - 7å±‚è¿‡æ»¤ç¡®ä¿å¯äº¤æ˜“æ€§
3. **Point-in-Timeå¯¹é½** - é˜²æ­¢æœªæ¥ä¿¡æ¯æ³„æ¼
4. **æ•°æ®è´¨é‡æŠ¥å‘Š** - è‡ªåŠ¨è´¨é‡æ£€æŸ¥å’ŒæŠ¥å‘Šç”Ÿæˆ

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ¨¡å—ç»„æˆ

```
data/
â”œâ”€â”€ data_snapshot.py        # æ•°æ®å¿«ç…§ç®¡ç†å™¨
â”œâ”€â”€ tradability_filter.py   # äº¤æ˜“å¯è¡Œæ€§è¿‡æ»¤å™¨
â”œâ”€â”€ pit_aligner.py          # PITæ•°æ®å¯¹é½å™¨
â””â”€â”€ data_loader.py          # å¢å¼ºç‰ˆæ•°æ®åŠ è½½å™¨ï¼ˆé›†æˆä»¥ä¸Šæ¨¡å—ï¼‰
```

### æ•°æ®æµç¨‹

```
åŸå§‹æ•°æ®
    â†“
[äº¤æ˜“å¯è¡Œæ€§è¿‡æ»¤] (7å±‚)
    â”œâ”€ 1. ST/é€€å¸‚
    â”œâ”€ 2. åœç‰Œ
    â”œâ”€ 3. æ¶¨è·Œåœ
    â”œâ”€ 4. ä¸Šå¸‚é¾„
    â”œâ”€ 5. æˆäº¤é‡
    â”œâ”€ 6. ä»·æ ¼
    â””â”€ 7. æ¢æ‰‹ç‡
    â†“
[PITå¯¹é½éªŒè¯]
    â”œâ”€ å°¾éƒ¨NaNä¿ç•™
    â”œâ”€ ç‰¹å¾shiftéªŒè¯
    â””â”€ æ—¶é—´é¡ºåºæ£€æŸ¥
    â†“
[æ•°æ®å¿«ç…§]
    â”œâ”€ ç‰ˆæœ¬åŒ–å­˜å‚¨
    â”œâ”€ å…ƒæ•°æ®è®°å½•
    â””â”€ è´¨é‡æŠ¥å‘Šç”Ÿæˆ
    â†“
å¯ç”¨äºæ¨¡å‹è®­ç»ƒ
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åŸºç¡€ä½¿ç”¨

```python
from data.data_loader import DataLoader

# åˆå§‹åŒ–æ•°æ®åŠ è½½å™¨ï¼ˆå¯ç”¨æ‰€æœ‰åŠŸèƒ½ï¼‰
loader = DataLoader(
    data_root="machine learning/ML output/datasets/baseline_v1",
    enable_snapshot=True,
    enable_filtering=True,
    enable_pit_alignment=True,
    filter_config={
        'min_volume': 1000000,
        'min_amount': 50000000,
        'min_price': 1.0,
        'min_turnover': 0.002,
        'min_listing_days': 60,
        'exclude_st': True,
        'exclude_limit_moves': True
    }
)

# åŠ è½½æ•°æ®å¹¶åˆ›å»ºå¿«ç…§
features, targets, snapshot_id = loader.load_with_snapshot(
    symbol='000001',
    start_date='2022-01-01',
    end_date='2024-12-31',
    target_col='future_return_5d',
    use_scaled=True,
    random_seed=42
)

print(f"å¿«ç…§ID: {snapshot_id}")
print(f"ç‰¹å¾å½¢çŠ¶: {features.shape}")
```

### 2. ä½¿ç”¨é›†æˆè„šæœ¬

```bash
# è¿è¡Œæ•°æ®å‡†å¤‡è„šæœ¬ï¼ˆå¸¦å¿«ç…§ç®¡ç†ï¼‰
cd "d:\vscode projects\stock\machine learning"
python pipelines/prepare_data_with_snapshot.py
```

### 3. ä»å¿«ç…§åŠ è½½æ•°æ®

```python
# ä»å·²æœ‰å¿«ç…§åŠ è½½
features, targets = loader.load_from_snapshot('ds_2025Q4_v1')
```

---

## ğŸ“Š æ•°æ®ç»“æ„è§„èŒƒ

### MultiIndexæ ¼å¼

```python
# ç´¢å¼•: [date, ticker]
DatetimeIndex(['2022-01-04', '2022-01-05', ...], name='date')
Index(['000001', '000001', ...], name='ticker')

# å¿…éœ€åˆ—
- ohlcv: open, high, low, close, volume, amount
- adj_factor: åå¤æƒå› å­
- tradable_flag: 0/1 å¯äº¤æ˜“æ ‡è®°
- industry_code: è¡Œä¸šä»£ç ï¼ˆå¯é€‰ï¼‰
- mkt_cap_float: æµé€šå¸‚å€¼ï¼ˆå¯é€‰ï¼‰
- shares_outstanding: æµé€šè‚¡æœ¬ï¼ˆå¯é€‰ï¼‰
```

### Parquetå­˜å‚¨

```
snapshots/
â””â”€â”€ ds_2025Q4_v1/
    â”œâ”€â”€ 000001_data.parquet  # æ•°æ®æ–‡ä»¶ï¼ˆå¿«é€Ÿã€åˆ—å­˜ï¼‰
    â””â”€â”€ metadata.json         # å…ƒæ•°æ®æ–‡ä»¶
```

---

## ğŸ” äº¤æ˜“å¯è¡Œæ€§è¿‡æ»¤

### 7å±‚è¿‡æ»¤é¡ºåº

| å±‚çº§ | è¿‡æ»¤é¡¹ | æ¡ä»¶ | è¯´æ˜ |
|------|--------|------|------|
| 1 | ST/é€€å¸‚ | è‚¡ç¥¨åç§°åŒ…å«ST | æ’é™¤ç‰¹æ®Šå¤„ç†è‚¡ç¥¨ |
| 2 | åœç‰Œ | æˆäº¤é‡=0 | æ— æ³•äº¤æ˜“ |
| 3 | æ¶¨è·Œåœ | æ¶¨è·Œå¹…>Â±9.5% | æµåŠ¨æ€§å—é™ |
| 4 | ä¸Šå¸‚é¾„ | ä¸Šå¸‚<60å¤© | æ–°è‚¡æ³¢åŠ¨å¤§ |
| 5 | æˆäº¤é‡ | volume<100ä¸‡ | æµåŠ¨æ€§ä¸è¶³ |
| 6 | ä»·æ ¼ | close<1å…ƒ | ä½ä»·è‚¡é£é™© |
| 7 | æ¢æ‰‹ç‡ | turnover<0.2% | æµåŠ¨æ€§ä¸è¶³ |

### è¿‡æ»¤æ—¥å¿—

```csv
filter,removed,remaining,ratio
1_ST_é€€å¸‚,50,950,0.95
2_åœç‰Œ,30,920,0.92
3_æ¶¨è·Œåœ,20,900,0.90
...
```

ä¿å­˜ä½ç½®: `ML output/datasets/baseline_v1/filter_log_{symbol}.csv`

---

## ğŸ“… Point-in-Time (PIT) å¯¹é½

### æ ¸å¿ƒåŸåˆ™

1. **è´¢åŠ¡æ•°æ®**: ä¸¥æ ¼æŒ‰`å…¬å‘Šæ—¥ + æ»åå¤©æ•°`ç”Ÿæ•ˆ
2. **å†å²æˆåˆ†**: ä½¿ç”¨å½“æ—¶çš„å®é™…æˆåˆ†ï¼ˆé¿å…å¹¸å­˜è€…åå·®ï¼‰
3. **ä»·æ ¼æ•°æ®**: åå¤æƒå¤„ç†
4. **äº¤æ˜“æ—¥å¯¹é½**: ç»Ÿä¸€åˆ°äº¤æ˜“æ—¥å†

### éªŒè¯æ£€æŸ¥

```python
pit_results = {
    'tail_nans_preserved': True,   # å°¾éƒ¨NaNä¿ç•™
    'features_valid': True,         # ç‰¹å¾æœ‰æ•ˆæ€§
    'time_ordered': True,           # æ—¶é—´é¡ºåº
    'overall_pass': True            # æ€»ä½“é€šè¿‡
}
```

---

## ğŸ“¸ æ•°æ®å¿«ç…§ç®¡ç†

### å¿«ç…§IDæ ¼å¼

```
ds_YYYYQQ_vN
```

ç¤ºä¾‹:
- `ds_2025Q4_v1` - 2025å¹´ç¬¬4å­£åº¦ç¬¬1ç‰ˆ
- `ds_2025Q4_v2` - 2025å¹´ç¬¬4å­£åº¦ç¬¬2ç‰ˆ

### å…ƒæ•°æ®è®°å½•

```json
{
  "snapshot_id": "ds_2025Q4_v1",
  "created_at": "2025-10-24T10:30:00",
  "symbol": "000001",
  "start_date": "2022-01-01",
  "end_date": "2024-12-31",
  "n_samples": 1000,
  "n_features": 20,
  "filters": {
    "min_volume": 1000000,
    "min_price": 1.0,
    "exclude_st": true
  },
  "random_seed": 42,
  "data_hash": "abc123...",
  "quality_checks": {...}
}
```

### å¿«ç…§åˆ—è¡¨

```python
snapshots = loader.snapshot_mgr.list_snapshots()
print(snapshots)

# è¾“å‡º:
#   snapshot_id     created_at        symbol  n_samples  quality
#   ds_2025Q4_v1    2025-10-24...     000001  1000       PASS
#   ds_2025Q4_v2    2025-10-25...     000001  1050       PASS
```

---

## ğŸ“Š æ•°æ®è´¨é‡æŠ¥å‘Š

### æ£€æŸ¥é¡¹

| æ£€æŸ¥é¡¹ | çº¢ç¯é˜ˆå€¼ | è¯´æ˜ |
|--------|----------|------|
| ç¼ºå¤±ç‡ | >20% | ä»»ä½•åˆ—ç¼ºå¤±ç‡è¿‡é«˜ |
| é‡å¤ç‡ | >1% | ç´¢å¼•é‡å¤ |
| å¯äº¤æ˜“æ ·æœ¬ | <70% | å¯äº¤æ˜“æ ·æœ¬è¿‡å°‘ |
| æ—¶é—´è¿ç»­æ€§ | é—´éš”>10å¤© | æ•°æ®ç¼ºå¤± |

### æŠ¥å‘Šç¤ºä¾‹

```json
{
  "timestamp": "2025-10-24T10:30:00",
  "total_samples": 1000,
  "checks": {
    "missing_ratio": {
      "max": 0.05,
      "mean": 0.01,
      "red_flag": false
    },
    "duplicates": {
      "count": 0,
      "ratio": 0.0,
      "red_flag": false
    },
    "tradable_samples": {
      "count": 900,
      "ratio": 0.90,
      "red_flag": false
    }
  },
  "overall_quality": "PASS",
  "red_flags_count": 0
}
```

ä¿å­˜ä½ç½®: `ML output/reports/data_quality/{snapshot_id}.json`

---

## âœ… éªŒæ”¶æ ‡å‡†

### æ•°æ®æ¸…æ´—å±‚éªŒæ”¶

æ ¹æ®ç ”ç©¶å®ªç« è¦æ±‚:

| æ£€æŸ¥é¡¹ | æ ‡å‡† | å½“å‰å®ç° |
|--------|------|----------|
| PITå¯¹é½ | é€šè¿‡éªŒè¯ | âœ… è‡ªåŠ¨éªŒè¯ |
| å†å²æˆåˆ† | æ— å¹¸å­˜è€…åå·® | âœ… æ”¯æŒå†å²æˆåˆ† |
| å¯äº¤æ˜“æ ·æœ¬ | â‰¥200/æ—¥ | âœ… å¯é…ç½®é˜ˆå€¼ |
| æ•°æ®è´¨é‡ | æ— çº¢ç¯é¡¹ | âœ… è‡ªåŠ¨æ£€æŸ¥ |
| ç‰ˆæœ¬åŒ– | å¿«ç…§IDè®°å½• | âœ… è‡ªåŠ¨ç”Ÿæˆ |
| å…ƒæ•°æ® | å®Œæ•´è®°å½• | âœ… JSONæ ¼å¼ |

### è¿è¡ŒéªŒæ”¶è„šæœ¬

```bash
python pipelines/prepare_data_with_snapshot.py
```

è¾“å‡ºç¤ºä¾‹:
```
[æ­¥éª¤7] æ•°æ®éªŒæ”¶æ£€æŸ¥
   âœ… æ ·æœ¬è§„æ¨¡: 1000 (æœ€ä½ 200)
   âœ… PITå¯¹é½éªŒè¯
   âœ… æ•°æ®è´¨é‡: PASS (0 ä¸ªçº¢ç¯)

======================================================================
âœ… éªŒæ”¶é€šè¿‡
======================================================================

ğŸ‰ æ­å–œ! æ•°æ®æ¸…æ´—ä¸å¿«ç…§å±‚éªŒæ”¶é€šè¿‡
   å¿«ç…§ID: ds_2025Q4_v1
   å¯ç”¨äºåç»­æ¨¡å‹è®­ç»ƒ
```

---

## ğŸ”§ é…ç½®è¯´æ˜

### é…ç½®æ–‡ä»¶: `configs/ml_baseline.yml`

```yaml
data:
  # æ•°æ®å¿«ç…§
  snapshot:
    enabled: true               # å¯ç”¨å¿«ç…§ç®¡ç†
    save_parquet: true         # ä¿å­˜ä¸ºParquetæ ¼å¼
    auto_generate_id: true     # è‡ªåŠ¨ç”Ÿæˆå¿«ç…§ID
    
  # äº¤æ˜“å¯è¡Œæ€§è¿‡æ»¤
  universe:
    min_volume: 1000000        # æœ€å°æˆäº¤é‡
    min_amount: 50000000       # æœ€å°æˆäº¤é¢ï¼ˆ5000ä¸‡ï¼‰
    min_price: 1.0             # æœ€å°ä»·æ ¼
    min_turnover: 0.002        # æœ€å°æ¢æ‰‹ç‡ï¼ˆ0.2%ï¼‰
    min_listing_days: 60       # æœ€å°ä¸Šå¸‚å¤©æ•°
    exclude_st: true           # æ’é™¤STè‚¡ç¥¨
    exclude_limit_moves: true  # æ’é™¤æ¶¨è·Œåœ
    limit_threshold: 0.095     # æ¶¨è·Œåœé˜ˆå€¼ï¼ˆ9.5%ï¼‰
    
  # PITå¯¹é½
  pit:
    enabled: true              # å¯ç”¨PITå¯¹é½
    financial_lag_days: 90     # è´¢åŠ¡æ•°æ®æ»åå¤©æ•°
    use_adj_factor: true       # ä½¿ç”¨åå¤æƒå› å­
    validate_alignment: true   # éªŒè¯PITå¯¹é½
```

---

## ğŸ“ è¾“å‡ºæ–‡ä»¶

### ç›®å½•ç»“æ„

```
ML output/
â”œâ”€â”€ snapshots/                    # æ•°æ®å¿«ç…§
â”‚   â””â”€â”€ ds_2025Q4_v1/
â”‚       â”œâ”€â”€ 000001_data.parquet   # æ•°æ®æ–‡ä»¶
â”‚       â””â”€â”€ metadata.json         # å…ƒæ•°æ®
â”‚
â”œâ”€â”€ reports/
â”‚   â””â”€â”€ data_quality/             # æ•°æ®è´¨é‡æŠ¥å‘Š
â”‚       â””â”€â”€ ds_2025Q4_v1.json
â”‚
â””â”€â”€ datasets/
    â””â”€â”€ baseline_v1/
        â””â”€â”€ filter_log_000001.csv  # è¿‡æ»¤æ—¥å¿—
```

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. æ¯æ¬¡å®éªŒå‰åˆ›å»ºæ–°å¿«ç…§

```python
# å›ºå®šå¿«ç…§IDåˆ°å®éªŒå…ƒæ•°æ®
features, targets, snapshot_id = loader.load_with_snapshot(...)

# è®°å½•åˆ°å®éªŒæ—¥å¿—
experiment_metadata = {
    'exp_id': 'EXP-20251024-001',
    'snapshot_id': snapshot_id,
    'random_seed': 42,
    'created_at': datetime.now().isoformat()
}
```

### 2. å¤ç°å®éªŒ

```python
# ä½¿ç”¨ç›¸åŒçš„å¿«ç…§ID
features, targets = loader.load_from_snapshot('ds_2025Q4_v1')

# ç¡®ä¿ç›¸åŒçš„éšæœºç§å­
np.random.seed(42)
```

### 3. ç‰ˆæœ¬æ§åˆ¶

- æ•°æ®å¿«ç…§ID: `ds_2025Q4_v1`
- å®éªŒID: `EXP-20251024-001`
- æ¨¡å‹ç‰ˆæœ¬: `baseline_v1`

### 4. å®¡è®¡è¿½è¸ª

```python
# æŸ¥çœ‹å¿«ç…§åˆ—è¡¨
snapshots = loader.snapshot_mgr.list_snapshots()

# æŸ¥çœ‹è´¨é‡æŠ¥å‘Š
quality_report_path = f"ML output/reports/data_quality/{snapshot_id}.json"

# æŸ¥çœ‹è¿‡æ»¤æ—¥å¿—
filter_log_path = f"ML output/datasets/baseline_v1/filter_log_{symbol}.csv"
```

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: Parquetä¿å­˜å¤±è´¥

**é—®é¢˜**: `ModuleNotFoundError: No module named 'pyarrow'`

**è§£å†³**:
```bash
pip install pyarrow
```

### Q2: è¿‡æ»¤åæ ·æœ¬æ•°è¿‡å°‘

**é—®é¢˜**: è¿‡æ»¤åå¯äº¤æ˜“æ ·æœ¬ < 200

**è§£å†³**:
1. é™ä½è¿‡æ»¤é˜ˆå€¼ï¼ˆå¦‚`min_volume`ï¼‰
2. æ‰©å±•æ—¶é—´èŒƒå›´
3. å¢åŠ è‚¡ç¥¨æ± 

### Q3: PITéªŒè¯å¤±è´¥

**é—®é¢˜**: `tail_nans_preserved = False`

**è§£å†³**:
æ£€æŸ¥ç›®æ ‡å˜é‡è®¡ç®—è¿‡ç¨‹ä¸­æ˜¯å¦æ­£ç¡®ä¿ç•™å°¾éƒ¨NaN

### Q4: è´¨é‡æŠ¥å‘Šçº¢ç¯

**é—®é¢˜**: æ•°æ®è´¨é‡æ£€æŸ¥å‡ºç°çº¢ç¯é¡¹

**è§£å†³**:
1. æŸ¥çœ‹è´¨é‡æŠ¥å‘Šè¯¦æƒ…
2. æ£€æŸ¥åŸå§‹æ•°æ®æº
3. è°ƒæ•´è¿‡æ»¤å‚æ•°æˆ–æ•°æ®èŒƒå›´

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ç ”ç©¶å®ªç«  v1.0](../docs/research_charter_v1.md)
- [å®éªŒæ—¥å¿—æ¨¡æ¿](../docs/experiments/EXPERIMENT_TEMPLATE.md)
- [æ•°æ®åŠ è½½å™¨APIæ–‡æ¡£](./data_loader.py)

---

## ğŸ”„ æ›´æ–°æ—¥å¿—

### v1.0 (2025-10-24)
- âœ… åˆå§‹ç‰ˆæœ¬
- âœ… æ•°æ®å¿«ç…§ç®¡ç†
- âœ… 7å±‚äº¤æ˜“å¯è¡Œæ€§è¿‡æ»¤
- âœ… PITå¯¹é½éªŒè¯
- âœ… æ•°æ®è´¨é‡æŠ¥å‘Š
- âœ… ç¬¦åˆç ”ç©¶å®ªç« è¦æ±‚

---

## ğŸ‘¥ ç»´æŠ¤è€…

HaOooMi - 2025å¹´10æœˆ24æ—¥

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®,è¯·å‚è€ƒç ”ç©¶å®ªç« æˆ–è”ç³»ç»´æŠ¤è€…ã€‚
