# 机器学习基线配置文件

# ===================== 项目标识 =====================
project:
  name: "baseline_v1"              # 项目名称（用于区分不同实验）
  description: "机器学习基线模型 - Ridge/RF/LightGBM 5日收益预测"
  version: "1.0"
  date: "2025-10-20"

# ===================== 路径配置 =====================
paths:
  data_root: "ML output"
  
  # reports/ 细分 - 按项目名称组织
  reports_dir: "ML output/reports/baseline_v1"
  reports_training: "ML output/reports/baseline_v1/training"      # 训练报告
  reports_evaluation: "ML output/reports/baseline_v1/evaluation"  # 评估报告
  reports_clustering: "ML output/reports/baseline_v1/clustering"  # 聚类报告
  reports_pca: "ML output/reports/baseline_v1/pca"                # PCA报告
  
  # models/ 细分 - 按项目名称组织
  models_dir: "ML output/models/baseline_v1"
  models_ridge: "ML output/models/baseline_v1/ridge"              # Ridge模型
  models_rf: "ML output/models/baseline_v1/random_forest"         # 随机森林模型
  models_lgbm: "ML output/models/baseline_v1/lightgbm"            # LightGBM模型
  models_pca: "ML output/models/baseline_v1/pca"                  # PCA模型
  
  # states/ 细分 - 按项目名称组织
  states_dir: "ML output/states/baseline_v1"
  states_train: "ML output/states/baseline_v1/train"              # 训练集状态
  states_valid: "ML output/states/baseline_v1/valid"              # 验证集状态
  states_test: "ML output/states/baseline_v1/test"                # 测试集状态
  
  # 其他目录 - 按项目名称组织
  predictions_dir: "ML output/predictions/baseline_v1"            # 预测结果
  scalers_dir: "ML output/scalers/baseline_v1"                    # 特征标准化器
  datasets_dir: "ML output/datasets/baseline_v1"                  # 完整数据集
  artifacts_dir: "ML output/artifacts/baseline_v1"
  figures_dir: "ML output/figures/baseline_v1"
  
# ===================== 数据配置 =====================
data:
  # 股票代码（支持单标的和多标的）
  # 单标的模式：symbol: "000001"
  # 多标的模式：symbol: ["000001", "600000", "000858"]
  # 测试模式：50只股票用于测试交易可行性过滤、财务数据、数据快照、图表生成
  symbol: [
    "000001", "000002", "000004", "000005", "000006", "000007", "000008", "000009", "000010", "000011",
    "000012", "000014", "000016", "000017", "000019", "000020", "000021", "000025", "000026", "000027",
    "000028", "000029", "000030", "000031", "000032", "000034", "000035", "000036", "000037", "000038",
    "000039", "000042", "000045", "000046", "000047", "000048", "000049", "000050", "000055", "000056",
    "000058", "000059", "000060", "000061", "000062", "000063", "000065", "000066", "000068", "000069"
  ]
  
  start_date: "2018-01-01"
  end_date: "2024-12-31"
  
  # 数据快照（版本化）
  snapshot:
    enabled: true                    # 是否启用快照管理
    save_parquet: true              # 是否保存为Parquet格式
    auto_generate_id: true          # 自动生成快照ID（如ds_2025Q4_v1）
    
  # 数据过滤（交易可行性）
  universe:
    min_volume: 2000            # 最小成交量（手，1手=100股）
    min_amount: 10000000        # 最小成交额（元）
    min_price: 1.0              # 最小价格（元）
    min_turnover: 0.1           # 最小换手率（注意：akshare返回的是百分比数值，0.1表示0.1%）
    min_listing_days: 60        # 最小上市天数
    exclude_st: true
    exclude_limit_moves: false  # 训练先不过滤涨跌停，更有利于覆盖全分布
    limit_threshold: 0.098      # 主板非ST阈值（9.8%，更接近实际10%涨跌停）
    
  # Point-in-Time (PIT) 对齐
  pit:
    enabled: true                   # 是否启用PIT对齐
    financial_lag_days: 90          # 财务数据滞后天数（公告日 + 90天 = 生效日期）
    financial_ffill_limit: 95       # 财务数据前向填充上限（天数）
                                     # 设计考虑：季报间隔90天 + 5天缓冲（周末/节假日）
                                     # 超过此期限无新财报 → 标记为NaN（可能存在披露问题）
    use_adj_factor: true            # 使用前复权因子
    validate_alignment: true        # 验证PIT对齐
  
  # InfluxDB 配置（从InfluxDB加载原始市场数据）
  influxdb:
    enabled: true                   # 是否启用InfluxDB数据加载
    url: "http://localhost:8086"    # InfluxDB 地址
    org: "stock"                    # 组织名称
    bucket: "stock_kdata"           # Bucket 名称
    token: "aIX6s47YmoJ-OY-rjRbLFl6AHFSYcv000g3vJp3f6l6hkbmvuj-AMtgfkjz0ESF7r536jqasqxzL9NhohGMrwA=="  # 访问令牌
    
# ===================== 特征配置 =====================
features:
  # 特征文件路径（从feature_engineering生成）
  use_scaled_features: false  # 使用原始特征（true 需要先运行特征标准化管道）
  use_neutralized_features: true  # 使用中性化因子（需要先运行prepare_factors.py且开启neutralize）
  
  # 特征预处理
  preprocessing:
    winsorize_quantile: [0.01, 0.99]  # 去极值分位数
    fillna_method: "forward"           # 缺失值填充方法
    standardize: true                  # 横截面标准化（Z-Score）
    neutralize: true                    # 因子中性化（需要market_cap/industry数据）
    neutralize_market_cap: true        # 市值中性化
    neutralize_industry: true          # 行业中性化
    
  # 因子工厂配置（因子库与稳健筛选）
  factor_factory:
    enabled: true             # 是否启用因子工厂
    
    # 因子生成参数
    generation:
      # 动量/反转族
      momentum:
        roc_periods: [5, 10, 20, 60, 120]         # ROC周期
        sma_periods: [20, 60, 120]                 # 移动平均周期
        longshort_windows: [[20, 60], [60, 120]]   # 长短动量窗口对
        
      # 波动率族
      volatility:
        windows: [20, 60]                          # 波动率窗口
        use_parkinson: true                        # 使用Parkinson估计器
        use_gk: true                               # 使用Garman-Klass估计器
        
      # 量价微观结构族
      volume_price:
        turnover_windows: [5, 20]                  # 换手率窗口
        vp_corr_windows: [20, 60]                  # 量价相关性窗口
        
      # 风格/质量族
      style:
        illiquidity_windows: [20]                  # 非流动性窗口
        price_range_windows: [20, 60]              # 价格范围窗口
    
    # 因子质量检查标准（双层体系：严格 + 探索）
    quality_check:
      # 严格标准（生产级，用于正式因子入库）
      strict:
        ic_threshold: 0.02                         # |IC|均值阈值
        icir_threshold: 0.5                        # |ICIR|年化阈值
        ic_pvalue: 0.05                            # IC显著性P值阈值
        
      # 探索标准（研究级，允许弱因子进入排序模型实验）
      exploratory:
        ic_threshold: 0.005                        # |IC|均值阈值（宽松）
        icir_threshold: 0.15                       # |ICIR|年化阈值（宽松）
        ic_pvalue: 0.10                            # IC显著性P值阈值（宽松）
        
      # 通用标准
      common:
        spread_threshold: 0.0                      # Spread阈值（Top-Bottom > 0）
        corr_threshold: 0.8                        # 相关性阈值（避免冗余）
        psi_threshold: 0.25                        # PSI阈值（分布稳定性）
        use_abs_ic: true                           # 使用|IC|筛选（保留负向因子）
        
      # 质量检查开关
      check_ic_decay: true                         # 检查IC衰减
      check_monotonicity: true                     # 检查单调性
      auto_fallback_to_exploratory: true           # 严格通过为0时自动降级到探索标准
      
    # 因子库管理
    library:
      min_qualified_factors: 10                    # 最小合格因子数
      max_factors_per_family: 5                    # 每族最大因子数（防止维度爆炸）
      version_control: true                        # 启用版本控制
      
    # 验收标准
    acceptance:
      min_factors: 10                              # 至少10个稳定因子
      min_significant_ratio: 0.8                   # 至少80%因子显著
      min_combined_ic: 0.03                        # 组合IC最低要求
    
# ===================== 目标配置 =====================
target:
  # 目标变量名称
  name: "future_return_5d"
  
  # 目标计算参数
  forward_periods: 5         # 未来收益率窗口（天）
  return_type: "log"         # 收益率类型：'simple' 或 'log'
  
  # 目标处理
  clip_quantile: [0.01, 0.99]  # 裁剪极端目标值
  
  # 标签变换（可选）
  transform: "none"          # 标签变换：'none', 'residual_vs_index', 'residual_vs_industry', 'rank'
  
# ===================== 排序模型配置 =====================
ranking:
  # 任务类型：'regression'（原始收益）、'regression_rank'（Reg-on-Rank）、'lambdarank'（排序模型）
  task_type: "regression"
  
  # Reg-on-Rank 配置
  regression_rank:
    rank_method: "zscore"      # 排序值变换：'zscore', 'gauss', 'uniform'
    min_samples_per_day: 30    # 每日最少样本数
  
  # LambdaRank 配置
  lambdarank:
    n_bins: 5                  # 分箱数（标签等级数）
    min_samples_per_day: 30    # 每日最少样本数
    ndcg_eval_at: [10, 30, 50] # NDCG@K 评估位置
    # 各等级增益权重（可选，默认自动计算 [0,1,3,7,15,...]）
    # label_gain: [0, 1, 3, 7, 15]
  
  # 验收标准
  acceptance:
    ic_improvement_ratio: 0.2  # 相比回归基线 IC 提升比例（≥20%）
    min_icir: 0.4              # 最低 ICIR 要求
    min_spread: 0.0            # Top-Mean Spread > 0
    min_top_coverage: 0.1      # Top bucket 最小覆盖率（10%）

# ===================== 数据切分配置 =====================
split:
  # 时间切分
  train_ratio: 0.6           # 训练集比例
  valid_ratio: 0.2           # 验证集比例
  test_ratio: 0.2            # 测试集比例
  
  # 防泄漏设置（Purged + Embargo）
  purge_days: 10             # 在切分点前剔除的天数（≥ max(target_horizon)）
  embargo_days: 5            # 禁止期天数（建议 target_horizon / 2）
  
  # 交叉验证模式
  cv_mode: "walk_forward"    # 模式：'single_split' 或 'walk_forward'（推荐walk_forward减少过拟合）
  
  # Walk-Forward 验证（当 cv_mode = 'walk_forward' 时生效）
  walk_forward:
    n_splits: 5              # 折数
    min_train_days: 252      # 最小训练日数（约1年）
    expanding: true          # 扩张窗口（true）vs 滚动窗口（false）
  
  # 漂移检测阈值
  drift_threshold: 0.3       # Valid vs Test 差异阈值（30%，放宽以适应小样本）
  
# ===================== 模型配置 =====================
models:
  # Ridge回归
  ridge:
    enabled: true
    params:
      alpha: [0.1, 1.0, 10.0, 100.0]  # 正则化参数网格
      fit_intercept: true
      random_state: 42
      
  # 随机森林
  random_forest:
    enabled: true
    params:
      n_estimators: 500
      max_depth: 10
      min_samples_leaf: 5
      min_samples_split: 10
      max_features: "sqrt"
      random_state: 42
      n_jobs: -1
      
  # LightGBM 回归
  lightgbm:
    enabled: true  # 如果安装失败会自动跳过
    params:
      n_estimators: 300          # 减少树数量防止过拟合
      learning_rate: 0.03        # 降低学习率增强稳定性
      num_leaves: 15             # 减少叶子数降低复杂度
      max_depth: 5               # 限制深度
      min_data_in_leaf: 50       # 增加叶子最小样本数
      feature_fraction: 0.6      # 降低特征采样比例
      bagging_fraction: 0.7      # 降低样本采样比例
      bagging_freq: 5
      lambda_l1: 0.5             # 增强L1正则化
      lambda_l2: 1.0             # 增强L2正则化
      random_state: 42
      verbose: -1
  
  # LightGBM 排序模型（LambdaRank）
  lightgbm_ranker:
    enabled: true
    params:
      objective: "lambdarank"
      metric: "ndcg"
      n_estimators: 500
      learning_rate: 0.05
      num_leaves: 31
      max_depth: 6            # 比回归更浅，防止过拟合
      min_data_in_leaf: 50    # 比回归更大，增强泛化
      feature_fraction: 0.7
      bagging_fraction: 0.8
      bagging_freq: 5
      lambda_l1: 0.1
      lambda_l2: 0.1
      random_state: 42
      verbose: -1
      
# ===================== 评估配置 =====================
evaluation:
  # 分桶设置
  n_buckets: 5               # 分桶数量
  bucket_method: "quantile"  # 分桶方法：'quantile' 或 'equal_width'
  daily_bucketing: true      # 按日横截面分桶（多标的模式必须为true）
  
  # 评估指标
  metrics:
    - "mse"                  # 均方误差
    - "mae"                  # 平均绝对误差
    - "ic"                   # 信息系数
    - "rank_ic"              # 排序信息系数
    - "top_bottom_spread"    # Top-Bottom收益差
    
  # 报告设置
  save_predictions: true     # 保存预测明细
  save_bucket_details: true  # 保存分桶详情
  generate_plots: false      # 生成可视化图表
  
# ===================== 回测配置 =====================
backtest:
  # 是否运行回测
  run_backtest: true
  
  # 策略设置
  strategy:
    type: "top_bucket"       # 策略类型
    rebalance_days: 5        # 调仓周期（天）
    weight_method: "equal"   # 持仓权重：'equal' 或 'weighted'
    
  # 交易成本（统一配置，回测模块必须读取此参数）
  transaction_cost:
    commission: 0.0003       # 佣金费率（双边，0.03%）
    slippage: 0.0010         # 滑点（双边，0.10%）
    # 总成本约 = (commission + slippage) × 2 = 0.26% 每回合
    
  # 基准对比
  benchmark:
    use_equal_weight: true   # 使用全体等权作为基准
    
# ===================== 输出配置 =====================
output:
  # 主报告文件名
  bucket_performance: "model_bucket_performance.csv"
  predictions_file: "test_predictions.csv"
  summary_file: "summary.json"
  
  # 模型持久化
  save_models: true
  model_format: "pickle"     # 'pickle' 或 'joblib'
  
  # 日志设置
  log_level: "INFO"          # DEBUG, INFO, WARNING, ERROR
  log_file: "training.log"
  
# ===================== 运行配置 =====================
runtime:
  # 随机种子
  random_seed: 42
  
  # 并行设置
  n_jobs: -1                 # -1表示使用所有CPU核心
  
  # 内存控制
  low_memory_mode: false     # 低内存模式（分块处理）
  
  # 缓存设置
  use_cache: true            # 使用中间结果缓存

# ===================== PCA配置 =====================
pca:
  enabled: false             # 是否启用PCA降维
  n_components: 0.95         # 保留的方差比例或组件数量
  save_transformed: true     # 保存降维后的特征
  
# ===================== 聚类配置 =====================
clustering:
  enabled: false             # 是否运行聚类分析
  k_range: [4, 5, 6]         # K值范围
  method: "kmeans"           # 聚类方法
  by_date: false             # 是否按日期横截面聚类
  max_iter: 300              # 最大迭代次数
  random_state: 42           # 随机种子
